<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><title>Baidu Cloud Engine JavaScript SDK</title><meta name="viewport" content="width=device-width"><link rel="stylesheet" href="/bce-sdk-js/css/draft.css"><script type="text/javascript" src="//use.typekit.net/vqa1hcx.js"></script><script type="text/javascript">try{Typekit.load();}catch(e){}</script></head><body><div class="container"><div class="nav-main"><div class="wrap"><a class="nav-home" href="/bce-sdk-js/">bce-sdk-js</a><ul class="nav-site"><li><a href="/bce-sdk-js/docs/overview.html#content" class="active">文档</a></li><li><a href="http://github.com/baidubce/bce-sdk-js" class="">源码</a></li><li><a href="https://bce.baidu.com/index.html" class="">百度开放云</a></li></ul></div></div><section class="content wrap documentationContent"><div class="nav-docs"><div class="nav-docs-section"><h3>Quick Start</h3><ul><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/overview.html#content">总览</a></li><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/quickstart-env-nodejs.html#content">Nodejs环境</a></li><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/quickstart-env-browser.html#content">浏览器环境</a></li></ul></div><div class="nav-docs-section"><h3>Advanced Topics</h3><ul><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/advanced-topics-basic-example-in-browser.html#content">在浏览器中直接上传文件到bos</a></li><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/advanced-topics-security-issue.html#content">AK和SK的安全性问题</a></li><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/advanced-topics-server-signature.html#content">服务端签名</a></li><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/advanced-topics-sts.html#content">STS临时认证</a></li><li><a style="margin-left:0;" class="active" href="/bce-sdk-js/docs/advanced-topics-multiupload.html#content">大文件分块上传</a></li><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/advanced-topics-postobject.html#content">IE低版本的处理</a></li></ul></div><div class="nav-docs-section"><h3>API Reference</h3><ul><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/api-reference-bos.html#content">BOS - api</a></li><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/api-reference-vod.html#content">VOD - api</a></li></ul></div></div><div class="inner-content"><a id="content"></a><h1>大文件分块上传</h1><div><p>对于大文件而言，可以采用分块上传，一方面可以利用浏览器多线程上传，加快上传速度；另一方面，把大文件分割成若干个小部分，每一部分传输出错可以单独重试，对其他部分没有影响，减小由于网络传输造成的出错重试成本。</p><p>分块上传比直接上传稍微复杂一点，直接上只需要调用putObjectFromBlob就可以了，而分块上传需要分为三个阶段：开始上传（initiateMultipartUpload）、上传分块（uploadPartFromBlob）、上传完成（completeMultipartUpload）。</p><h3><a class="anchor" name=""></a>前端代码示例 <a class="hash-link" href="#">#</a></h3><pre class="prism language-javascript">
<span class="token keyword">var</span> PART_SIZE <span class="token operator">=</span> <span class="token number">5</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true"> // 指定分块大小
</span><span class="token comment" spellcheck="true">
// 按照指定的分块大小对文件进行分块
</span><span class="token keyword">function</span> <span class="token function">getTasks<span class="token punctuation">(</span></span>file<span class="token punctuation">,</span> uploadId<span class="token punctuation">,</span> bucketName<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> leftSize <span class="token operator">=</span> file<span class="token punctuation">.</span>size<span class="token punctuation">;</span>
    <span class="token keyword">var</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> partNumber <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> tasks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>leftSize <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> partSize <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min<span class="token punctuation">(</span></span>leftSize<span class="token punctuation">,</span> PART_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        tasks<span class="token punctuation">.</span><span class="token function">push<span class="token punctuation">(</span></span><span class="token punctuation">{</span>
            file<span class="token punctuation">:</span> file<span class="token punctuation">,</span>
            uploadId<span class="token punctuation">:</span> uploadId<span class="token punctuation">,</span>
            bucketName<span class="token punctuation">:</span> bucketName<span class="token punctuation">,</span>
            key<span class="token punctuation">:</span> key<span class="token punctuation">,</span>
            partNumber<span class="token punctuation">:</span> partNumber<span class="token punctuation">,</span>
            partSize<span class="token punctuation">:</span> partSize<span class="token punctuation">,</span>
            start<span class="token punctuation">:</span> offset<span class="token punctuation">,</span>
            stop<span class="token punctuation">:</span> offset <span class="token operator">+</span> partSize <span class="token operator">-</span> <span class="token number">1</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        leftSize <span class="token operator">-</span><span class="token operator">=</span> partSize<span class="token punctuation">;</span>
        offset <span class="token operator">+</span><span class="token operator">=</span> partSize<span class="token punctuation">;</span>
        partNumber <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> tasks<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">
// 定义分块上传的方法
</span><span class="token keyword">function</span> <span class="token function">uploadPartFile<span class="token punctuation">(</span></span>state<span class="token punctuation">,</span> client<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> blob <span class="token operator">=</span> task<span class="token punctuation">.</span>file<span class="token punctuation">.</span><span class="token function">slice<span class="token punctuation">(</span></span>task<span class="token punctuation">.</span>start<span class="token punctuation">,</span> task<span class="token punctuation">.</span>stop <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        client<span class="token punctuation">.</span><span class="token function">uploadPartFromBlob<span class="token punctuation">(</span></span>task<span class="token punctuation">.</span>bucketName<span class="token punctuation">,</span> task<span class="token punctuation">.</span>key<span class="token punctuation">,</span> task<span class="token punctuation">.</span>uploadId<span class="token punctuation">,</span> task<span class="token punctuation">.</span>partNumber<span class="token punctuation">,</span> task<span class="token punctuation">.</span>partSize<span class="token punctuation">,</span> blob<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">then<span class="token punctuation">(</span></span><span class="token keyword">function</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token operator">++</span>state<span class="token punctuation">.</span>loaded<span class="token punctuation">;</span>
                client<span class="token punctuation">.</span><span class="token function">emit<span class="token punctuation">(</span></span><span class="token string">&#x27;overallProgress&#x27;</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">callback<span class="token punctuation">(</span></span><span class="token keyword">null</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">callback<span class="token punctuation">(</span></span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> uploadId<span class="token punctuation">;</span><span class="token comment" spellcheck="true"> // 开始上传时，由服务器生成本次分块上传的id，所有分块都要用
</span>promise <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">initiateMultipartUpload<span class="token punctuation">(</span></span>bucket<span class="token punctuation">,</span> key<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then<span class="token punctuation">(</span></span><span class="token keyword">function</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        uploadId <span class="token operator">=</span> response<span class="token punctuation">.</span>body<span class="token punctuation">.</span>uploadId<span class="token punctuation">;</span><span class="token comment" spellcheck="true"> // 开始上传，获取服务器生成的uploadId
</span>
        <span class="token keyword">var</span> deferred <span class="token operator">=</span> sdk<span class="token punctuation">.</span>Q<span class="token punctuation">.</span><span class="token function">defer<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> tasks <span class="token operator">=</span> <span class="token function">getTasks<span class="token punctuation">(</span></span>blob<span class="token punctuation">,</span> uploadId<span class="token punctuation">,</span> bucket<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> state <span class="token operator">=</span> <span class="token punctuation">{</span>
            lengthComputable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            loaded<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            total<span class="token punctuation">:</span> tasks<span class="token punctuation">.</span>length
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

       <span class="token comment" spellcheck="true"> // 为了管理分块上传，使用了async（https://github.com/caolan/async）库来进行异步处理
</span>        <span class="token keyword">var</span> THREADS <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true"> // 同时上传的分块数量
</span>        async<span class="token punctuation">.</span><span class="token function">mapLimit<span class="token punctuation">(</span></span>tasks<span class="token punctuation">,</span> THREADS<span class="token punctuation">,</span> <span class="token function">uploadPartFile<span class="token punctuation">(</span></span>state<span class="token punctuation">,</span> client<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> results<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                deferred<span class="token punctuation">.</span><span class="token function">reject<span class="token punctuation">(</span></span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                deferred<span class="token punctuation">.</span><span class="token function">resolve<span class="token punctuation">(</span></span>results<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> deferred<span class="token punctuation">.</span>promise<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then<span class="token punctuation">(</span></span><span class="token keyword">function</span><span class="token punctuation">(</span>allResponse<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> partList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        allResponse<span class="token punctuation">.</span><span class="token function">forEach<span class="token punctuation">(</span></span><span class="token keyword">function</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token comment" spellcheck="true"> // 生成分块清单
</span>            partList<span class="token punctuation">.</span><span class="token function">push<span class="token punctuation">(</span></span><span class="token punctuation">{</span>
                partNumber<span class="token punctuation">:</span> index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>
                eTag<span class="token punctuation">:</span> response<span class="token punctuation">.</span>http_headers<span class="token punctuation">.</span>etag
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> client<span class="token punctuation">.</span><span class="token function">completeMultipartUpload<span class="token punctuation">(</span></span>bucket<span class="token punctuation">,</span> key<span class="token punctuation">,</span> uploadId<span class="token punctuation">,</span> partList<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true"> // 完成上传
</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
client<span class="token punctuation">.</span><span class="token function">on<span class="token punctuation">(</span></span><span class="token string">&#x27;overallProgress&#x27;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>evt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment" spellcheck="true"> // 监听上传进度
</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>evt<span class="token punctuation">.</span>lengthComputable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment" spellcheck="true"> // 添加您的代码
</span>        <span class="token keyword">var</span> percentage <span class="token operator">=</span> <span class="token punctuation">(</span>evt<span class="token punctuation">.</span>loaded <span class="token operator">/</span> evt<span class="token punctuation">.</span>total<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log<span class="token punctuation">(</span></span><span class="token string">&#x27;上传中，已上传了&#x27;</span> <span class="token operator">+</span> percentage <span class="token operator">+</span> <span class="token string">&#x27;%&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
promise<span class="token punctuation">.</span><span class="token function">then<span class="token punctuation">(</span></span><span class="token keyword">function</span> <span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment" spellcheck="true"> // 上传完成，添加您的代码
</span>        console<span class="token punctuation">.</span><span class="token function">log<span class="token punctuation">(</span></span><span class="token string">&#x27;上传成功，下载地址：&#x27;</span> <span class="token operator">+</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment" spellcheck="true"> // 上传失败，添加您的代码
</span>        console<span class="token punctuation">.</span><span class="token function">error<span class="token punctuation">(</span></span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre><p>在完成上传的步骤中，参数中需要带上上传区块的清单时需要每个分块上传成功时的ETag，为了能正确地接收BOS服务器返回的这个字段，您需要在相关bucket的cors设置中，在ExposeHeaders中添加“ETag”，如下图所示。</p><p><img src="http://bos.bj.baidubce.com/v1/bce-javascript-sdk-demo-test/%E7%A4%BA%E4%BE%8B%E5%9B%BE.png" alt=""></p><h3><a class="anchor" name=""></a>自动重试 <a class="hash-link" href="#">#</a></h3><p>对于网络条件不佳的环境，可能在上传阶段出现错误，有初始化 BOS 服务的时候可以指定网络错误重试的次数：</p><pre class="prism language-javascript">
<span class="token keyword">var</span> bosConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
    credentials<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        ak<span class="token punctuation">:</span> <span class="token string">&#x27;您的AK&#x27;</span><span class="token punctuation">,</span>
        sk<span class="token punctuation">:</span> <span class="token string">&#x27;您的SK&#x27;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    retry<span class="token punctuation">:</span> <span class="token number">50</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true"> // 指定重试的次数
</span>    endpoint<span class="token punctuation">:</span> <span class="token string">&#x27;http://bos.bj.baidubce.com&#x27;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></pre></div><div class="docs-prevnext"><a class="docs-next" href="advanced-topics-postobject.html#content">下一篇 →</a></div></div></section><footer class="wrap"><div class="right">© 2016 Baidu Inc.</div></footer></div></body></html>