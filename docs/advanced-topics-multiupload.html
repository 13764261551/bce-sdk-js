<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><title>Baidu Cloud Engine JavaScript SDK</title><meta name="viewport" content="width=device-width"><link rel="stylesheet" href="/bce-sdk-js/css/draft.css"><script type="text/javascript" src="//use.typekit.net/vqa1hcx.js"></script><script type="text/javascript">try{Typekit.load();}catch(e){}</script></head><body><div class="container"><div class="nav-main"><div class="wrap"><a class="nav-home" href="/bce-sdk-js/">bce-sdk-js</a><ul class="nav-site"><li><a href="/bce-sdk-js/docs/overview.html#content" class="active">文档</a></li><li><a href="http://github.com/baidubce/bce-sdk-js" class="">源码</a></li><li><a href="https://bce.baidu.com/index.html" class="">百度开放云</a></li></ul></div></div><section class="content wrap documentationContent"><div class="nav-docs"><div class="nav-docs-section"><h3>Quick Start</h3><ul><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/overview.html#content">总览</a></li><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/quickstart-env-nodejs.html#content">Nodejs环境</a></li><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/quickstart-env-browser.html#content">浏览器环境</a></li></ul></div><div class="nav-docs-section"><h3>Advanced Topics</h3><ul><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/advanced-topics-basic-example-in-browser.html#content">在浏览器中直接上传文件到bos</a></li><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/advanced-topics-security-issue.html#content">AK和SK的安全性问题</a></li><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/advanced-topics-server-signature.html#content">服务端签名</a></li><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/advanced-topics-sts.html#content">STS临时认证</a></li><li><a style="margin-left:0;" class="active" href="/bce-sdk-js/docs/advanced-topics-multiupload.html#content">大文件分块上传</a></li><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/advanced-topics-uploader.html#content">bce bos uploader</a></li><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/advanced-topics-programming-style.html#content">多种异步编程风格</a></li><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/advanced-topics-postobject.html#content">IE低版本的处理</a></li></ul></div><div class="nav-docs-section"><h3>API Reference</h3><ul><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/api-reference-bos.html#content">BOS - api</a></li><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/api-reference-vod.html#content">VOD - api</a></li></ul></div></div><div class="inner-content"><a id="content"></a><h1>大文件分块上传</h1><div><p>对于大文件而言，可以采用分块上传，一方面可以利用浏览器多线程上传，加快上传速度；另一方面，把大文件分割成若干个小部分，每一部分传输出错可以单独重试，对其他部分没有影响，减小由于网络传输造成的出错重试成本。</p><p>分块上传比直接上传稍微复杂一点，直接上传只需要调用putObjectFromBlob就可以了，而分块上传需要分为三个阶段：</p><ul><li>开始上传（initiateMultipartUpload）</li><li>上传分块（uploadPartFromBlob）</li><li>上传完成（completeMultipartUpload）</li></ul><h3><a class="anchor" name="%E6%B5%8F%E8%A7%88%E5%99%A8%E7%AB%AF%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B"></a>浏览器端代码示例 <a class="hash-link" href="#%E6%B5%8F%E8%A7%88%E5%99%A8%E7%AB%AF%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B">#</a></h3><p>按照指定的分块大小对文件进行分块</p><pre class="prism language-javascript">
<span class="token keyword">var</span> PART_SIZE <span class="token operator">=</span> <span class="token number">5</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true"> // 指定分块大小
</span>
<span class="token keyword">function</span> <span class="token function">getTasks<span class="token punctuation">(</span></span>file<span class="token punctuation">,</span> uploadId<span class="token punctuation">,</span> bucketName<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> leftSize <span class="token operator">=</span> file<span class="token punctuation">.</span>size<span class="token punctuation">;</span>
    <span class="token keyword">var</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> partNumber <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> tasks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>leftSize <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> partSize <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min<span class="token punctuation">(</span></span>leftSize<span class="token punctuation">,</span> PART_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        tasks<span class="token punctuation">.</span><span class="token function">push<span class="token punctuation">(</span></span><span class="token punctuation">{</span>
            file<span class="token punctuation">:</span> file<span class="token punctuation">,</span>
            uploadId<span class="token punctuation">:</span> uploadId<span class="token punctuation">,</span>
            bucketName<span class="token punctuation">:</span> bucketName<span class="token punctuation">,</span>
            key<span class="token punctuation">:</span> key<span class="token punctuation">,</span>
            partNumber<span class="token punctuation">:</span> partNumber<span class="token punctuation">,</span>
            partSize<span class="token punctuation">:</span> partSize<span class="token punctuation">,</span>
            start<span class="token punctuation">:</span> offset<span class="token punctuation">,</span>
            stop<span class="token punctuation">:</span> offset <span class="token operator">+</span> partSize <span class="token operator">-</span> <span class="token number">1</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        leftSize <span class="token operator">-</span><span class="token operator">=</span> partSize<span class="token punctuation">;</span>
        offset <span class="token operator">+</span><span class="token operator">=</span> partSize<span class="token punctuation">;</span>
        partNumber <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> tasks<span class="token punctuation">;</span>
<span class="token punctuation">}</span></pre><p>处理每个分块上传的逻辑</p><pre class="prism language-javascript">
<span class="token keyword">function</span> <span class="token function">uploadPartFile<span class="token punctuation">(</span></span>state<span class="token punctuation">,</span> client<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> blob <span class="token operator">=</span> task<span class="token punctuation">.</span>file<span class="token punctuation">.</span><span class="token function">slice<span class="token punctuation">(</span></span>task<span class="token punctuation">.</span>start<span class="token punctuation">,</span> task<span class="token punctuation">.</span>stop <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        client<span class="token punctuation">.</span><span class="token function">uploadPartFromBlob<span class="token punctuation">(</span></span>task<span class="token punctuation">.</span>bucketName<span class="token punctuation">,</span> task<span class="token punctuation">.</span>key<span class="token punctuation">,</span> task<span class="token punctuation">.</span>uploadId<span class="token punctuation">,</span> task<span class="token punctuation">.</span>partNumber<span class="token punctuation">,</span> task<span class="token punctuation">.</span>partSize<span class="token punctuation">,</span> blob<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">then<span class="token punctuation">(</span></span><span class="token keyword">function</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token operator">++</span>state<span class="token punctuation">.</span>loaded<span class="token punctuation">;</span>
                <span class="token function">callback<span class="token punctuation">(</span></span><span class="token keyword">null</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">callback<span class="token punctuation">(</span></span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></pre><p>初始化uploadId，然后开始上传分块</p><pre class="prism language-javascript">
<span class="token keyword">var</span> uploadId<span class="token punctuation">;</span>
client<span class="token punctuation">.</span><span class="token function">initiateMultipartUpload<span class="token punctuation">(</span></span>bucket<span class="token punctuation">,</span> key<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then<span class="token punctuation">(</span></span><span class="token keyword">function</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        uploadId <span class="token operator">=</span> response<span class="token punctuation">.</span>body<span class="token punctuation">.</span>uploadId<span class="token punctuation">;</span><span class="token comment" spellcheck="true"> // 开始上传，获取服务器生成的uploadId
</span>
        <span class="token keyword">var</span> deferred <span class="token operator">=</span> sdk<span class="token punctuation">.</span>Q<span class="token punctuation">.</span><span class="token function">defer<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> tasks <span class="token operator">=</span> <span class="token function">getTasks<span class="token punctuation">(</span></span>blob<span class="token punctuation">,</span> uploadId<span class="token punctuation">,</span> bucket<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> state <span class="token operator">=</span> <span class="token punctuation">{</span>
            lengthComputable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            loaded<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            total<span class="token punctuation">:</span> tasks<span class="token punctuation">.</span>length
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

       <span class="token comment" spellcheck="true"> // 为了管理分块上传，使用了async（https://github.com/caolan/async）库来进行异步处理
</span>        <span class="token keyword">var</span> THREADS <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true"> // 同时上传的分块数量
</span>        async<span class="token punctuation">.</span><span class="token function">mapLimit<span class="token punctuation">(</span></span>tasks<span class="token punctuation">,</span> THREADS<span class="token punctuation">,</span> <span class="token function">uploadPartFile<span class="token punctuation">(</span></span>state<span class="token punctuation">,</span> client<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> results<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                deferred<span class="token punctuation">.</span><span class="token function">reject<span class="token punctuation">(</span></span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                deferred<span class="token punctuation">.</span><span class="token function">resolve<span class="token punctuation">(</span></span>results<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> deferred<span class="token punctuation">.</span>promise<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then<span class="token punctuation">(</span></span><span class="token keyword">function</span><span class="token punctuation">(</span>allResponse<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> partList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        allResponse<span class="token punctuation">.</span><span class="token function">forEach<span class="token punctuation">(</span></span><span class="token keyword">function</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token comment" spellcheck="true"> // 生成分块清单
</span>            partList<span class="token punctuation">.</span><span class="token function">push<span class="token punctuation">(</span></span><span class="token punctuation">{</span>
                partNumber<span class="token punctuation">:</span> index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>
                eTag<span class="token punctuation">:</span> response<span class="token punctuation">.</span>http_headers<span class="token punctuation">.</span>etag
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> client<span class="token punctuation">.</span><span class="token function">completeMultipartUpload<span class="token punctuation">(</span></span>bucket<span class="token punctuation">,</span> key<span class="token punctuation">,</span> uploadId<span class="token punctuation">,</span> partList<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true"> // 完成上传
</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then<span class="token punctuation">(</span></span><span class="token keyword">function</span> <span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment" spellcheck="true"> // 上传完成
</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment" spellcheck="true"> // 上传失败，添加您的代码
</span>        console<span class="token punctuation">.</span><span class="token function">error<span class="token punctuation">(</span></span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre><h3><a class="anchor" name="nodejs%E7%AB%AF%E4%BD%BF%E7%94%A8%E5%88%86%E5%9D%97%E4%B8%8A%E4%BC%A0"></a>nodejs端使用分块上传 <a class="hash-link" href="#nodejs%E7%AB%AF%E4%BD%BF%E7%94%A8%E5%88%86%E5%9D%97%E4%B8%8A%E4%BC%A0">#</a></h3><p>与浏览器端很类似，直接上传只需要调用putObjectFromFile就可以了，而分块上传需要分为三个阶段：</p><ul><li>开始上传（initiateMultipartUpload）</li><li>上传分块（uploadPartFromFile）</li><li>上传完成（completeMultipartUpload）</li></ul><h3><a class="anchor" name="%E5%8F%96%E6%B6%88%E5%88%86%E5%9D%97%E4%B8%8A%E4%BC%A0%E4%BA%8B%E4%BB%B6"></a>取消分块上传事件 <a class="hash-link" href="#%E5%8F%96%E6%B6%88%E5%88%86%E5%9D%97%E4%B8%8A%E4%BC%A0%E4%BA%8B%E4%BB%B6">#</a></h3><p>用户可以使用abortMultipartUpload方法取消分块上传。</p><pre class="prism language-javascript">
client<span class="token punctuation">.</span><span class="token function">abortMultipartUpload<span class="token punctuation">(</span></span>&lt;bucketName<span class="token operator">&gt;</span><span class="token punctuation">,</span> &lt;key<span class="token operator">&gt;</span><span class="token punctuation">,</span> &lt;uploadId<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre><h3><a class="anchor" name="%E8%8E%B7%E5%8F%96%E6%9C%AA%E5%AE%8C%E6%88%90%E7%9A%84%E5%88%86%E5%9D%97%E4%B8%8A%E4%BC%A0%E4%BA%8B%E4%BB%B6"></a>获取未完成的分块上传事件 <a class="hash-link" href="#%E8%8E%B7%E5%8F%96%E6%9C%AA%E5%AE%8C%E6%88%90%E7%9A%84%E5%88%86%E5%9D%97%E4%B8%8A%E4%BC%A0%E4%BA%8B%E4%BB%B6">#</a></h3><p>用户可以使用listMultipartUploads方法获取Bucket内未完成的分块上传事件。</p><pre class="prism language-javascript">
client<span class="token punctuation">.</span><span class="token function">listMultipartUploads<span class="token punctuation">(</span></span>&lt;bucketName<span class="token operator">&gt;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then<span class="token punctuation">(</span></span><span class="token keyword">function</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment" spellcheck="true"> // 遍历所有上传事件
</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> upload <span class="token keyword">in</span> response<span class="token punctuation">.</span>body<span class="token punctuation">.</span>multipartUploads<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log<span class="token punctuation">(</span></span>upload<span class="token punctuation">.</span>uploadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre><h3><a class="anchor" name="%E8%8E%B7%E5%8F%96%E6%89%80%E6%9C%89%E5%B7%B2%E4%B8%8A%E4%BC%A0%E7%9A%84%E5%9D%97%E4%BF%A1%E6%81%AF"></a>获取所有已上传的块信息 <a class="hash-link" href="#%E8%8E%B7%E5%8F%96%E6%89%80%E6%9C%89%E5%B7%B2%E4%B8%8A%E4%BC%A0%E7%9A%84%E5%9D%97%E4%BF%A1%E6%81%AF">#</a></h3><p>用户可以使用listParts方法获取某个上传事件中所有已上传的块。</p><pre class="prism language-javascript">
client<span class="token punctuation">.</span><span class="token function">listParts<span class="token punctuation">(</span></span>&lt;bucketName<span class="token operator">&gt;</span><span class="token punctuation">,</span> &lt;key<span class="token operator">&gt;</span><span class="token punctuation">,</span> &lt;uploadId<span class="token operator">&gt;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then<span class="token punctuation">(</span></span><span class="token keyword">function</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment" spellcheck="true"> // 遍历所有上传事件
</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> part <span class="token keyword">in</span> response<span class="token punctuation">.</span>body<span class="token punctuation">.</span>parts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log<span class="token punctuation">(</span></span>part<span class="token punctuation">.</span>partNumber<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></div><div class="docs-prevnext"><a class="docs-next" href="advanced-topics-uploader.html#content">下一篇 →</a></div></div></section><footer class="wrap"><div class="right">© 2016 Baidu Inc.</div></footer></div></body></html>