<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><title>Baidu Cloud Engine JavaScript SDK</title><meta name="viewport" content="width=device-width"><link rel="stylesheet" href="/bce-sdk-js/css/draft.css"><script type="text/javascript" src="//use.typekit.net/vqa1hcx.js"></script><script type="text/javascript">try{Typekit.load();}catch(e){}</script></head><body><div class="container"><div class="nav-main"><div class="wrap"><a class="nav-home" href="/bce-sdk-js/">bce-sdk-js</a><ul class="nav-site"><li><a href="/bce-sdk-js/docs/overview.html#content" class="active">文档</a></li><li><a href="http://github.com/baidubce/bce-sdk-js" class="">源码</a></li><li><a href="https://bce.baidu.com/index.html" class="">百度开放云</a></li></ul></div></div><section class="content wrap documentationContent"><div class="nav-docs"><div class="nav-docs-section"><h3>API Reference</h3><ul><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/api-reference-cfc.html#content">CFC - api</a></li></ul></div></div><div class="inner-content"><a id="content"></a><h1>多种异步编程风格</h1><div><p>在bce-sdk-js中，所有的服务交互接口均是异步接口，返回一个Promise对象。</p><p>以Node.js为例，让我们先初始化一个BosClient：</p><pre class="prism language-javascript">
import <span class="token punctuation">{</span>BosClient<span class="token punctuation">}</span> from <span class="token string">&#x27;bce-sdk-js&#x27;</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
    endpoint<span class="token punctuation">:</span> <span class="token string">&#x27;http://bos.bj.baidubce.com&#x27;</span><span class="token punctuation">,</span>
    credentials<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        ak<span class="token punctuation">:</span> <span class="token string">&#x27;您的ak&#x27;</span><span class="token punctuation">,</span>
        sk<span class="token punctuation">:</span> <span class="token string">&#x27;您的sk&#x27;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BosClient</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><p>然后设想以下流程：</p><ul><li>在BOS中创建一个bucket，名称为<code>bucket-for-test</code>；</li><li>在这个bucket中上传一个Object，key为<code>test</code>;</li><li>删除这个Object</li></ul><p>我们应该如何实现这样的流程呢？</p><h2><a class="anchor" name="promise%E5%AE%9E%E7%8E%B0%EF%BC%88%E9%BB%98%E8%AE%A4%E5%BC%82%E6%AD%A5%E9%A3%8E%E6%A0%BC%EF%BC%89"></a>Promise实现（默认异步风格） <a class="hash-link" href="#promise%E5%AE%9E%E7%8E%B0%EF%BC%88%E9%BB%98%E8%AE%A4%E5%BC%82%E6%AD%A5%E9%A3%8E%E6%A0%BC%EF%BC%89">#</a></h2><pre class="prism language-javascript">
<span class="token comment" spellcheck="true">// 0. 开始流程
</span>client<span class="token punctuation">.</span><span class="token function">createBucket<span class="token punctuation">(</span></span><span class="token string">&#x27;bucket-for-test&#x27;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then<span class="token punctuation">(</span></span><span class="token keyword">function</span> <span class="token punctuation">(</span>response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment" spellcheck="true"> // 2. 完成bucket创建
</span>        <span class="token keyword">return</span> client<span class="token punctuation">.</span><span class="token function">putObjectFromString<span class="token punctuation">(</span></span><span class="token string">&#x27;bucket-for-test&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;test&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;hello world&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then<span class="token punctuation">(</span></span><span class="token keyword">function</span> <span class="token punctuation">(</span>response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment" spellcheck="true"> // 3. 完成Object上传
</span>        <span class="token keyword">return</span> client<span class="token punctuation">.</span><span class="token function">deleteObject<span class="token punctuation">(</span></span><span class="token string">&#x27;bucket-for-test&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;test&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then<span class="token punctuation">(</span></span><span class="token keyword">function</span> <span class="token punctuation">(</span>response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment" spellcheck="true"> // 4. 完成Object删除
</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment" spellcheck="true"> // 异常处理
</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">
// 1. 先执行其他代码，api操作异步执行</span></pre><p>在上面的示例中，实际运行时会按照注释中编号的次序执行。通过<code>catch</code>方法统一处理异常。</p><p>这种编程风格过程比较清晰，Node.js端和浏览器端都可以直接使用，bce-sdk-js默认支持这种编程风格。想了解更多关于Promise的api，请参考<a href="http://documentup.com/kriskowal/q/" target="_blank">此文档</a>。</p><h2><a class="anchor" name="generator%20function%E5%AE%9E%E7%8E%B0"></a>Generator Function实现 <a class="hash-link" href="#generator%20function%E5%AE%9E%E7%8E%B0">#</a></h2><p>可能有些开发者会更习惯同步风格的api调用方式。但由于Node.js语言本身的限制，这种做法并不多见。但在es6中，我们可以使用<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/function*" target="_blank">Generator Function</a>来进行更灵活的流程控制，这可以帮助我们很方便地实现同步调用的编程风格。</p><p>为了简化开发，我们需要<a href="https://github.com/tj/co" target="_blank">co</a>库的配合：</p><pre class="prism language-javascript">
npm install <span class="token operator">--</span>save co</pre><p>下面的代码来演示整个流程：</p><pre class="prism language-javascript">
import co from <span class="token string">&#x27;co&#x27;</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">
// 0. 开始流程
</span><span class="token function">co<span class="token punctuation">(</span></span><span class="token keyword">function</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> response <span class="token operator">=</span> yield client<span class="token punctuation">.</span><span class="token function">createBucket<span class="token punctuation">(</span></span><span class="token string">&#x27;bucket-for-test&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment" spellcheck="true"> // 2. 完成bucket创建
</span>
    response <span class="token operator">=</span> yield client<span class="token punctuation">.</span><span class="token function">putObjectFromString<span class="token punctuation">(</span></span><span class="token string">&#x27;bucket-for-test&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;test&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;hello world&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment" spellcheck="true"> // 3. 完成Object上传
</span>
    response <span class="token operator">=</span> yield client<span class="token punctuation">.</span><span class="token function">deleteObject<span class="token punctuation">(</span></span><span class="token string">&#x27;bucket-for-test&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;test&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment" spellcheck="true"> // 4. 完成Object删除
</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment" spellcheck="true"> // 异常处理
</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">
// 1. 先执行其他代码，api操作异步执行</span></pre><p>co库的作用是帮助开发者把处理generator中流程的复杂操作省略了，并且让Promise对象成为“yieldable”。开发者可以参照以上代码，以同步的风格进行开发。</p><h3><a class="anchor" name="%E5%85%BC%E5%AE%B9%E6%83%85%E5%86%B5"></a>兼容情况 <a class="hash-link" href="#%E5%85%BC%E5%AE%B9%E6%83%85%E5%86%B5">#</a></h3><ul><li><p>在Node.js的较新的版本中（建议使用最新的稳定版本），已经提供了es-harmony的支持，而Generator Function的支持亦包含在其中。你可以这样开启：</p><pre class="prism language-javascript">
  node <span class="token operator">--</span>harmony yourScript<span class="token punctuation">.</span>js</pre></li><li><p>在浏览器中的支持情况可见下表：</p></li></ul><table><thead><tr><th>Chrome</th><th>Firefox</th><th>IE</th><th>Edge</th><th>Opera</th><th>Safari</th></tr></thead><thead><tr><td>39.0</td><td>26.0</td><td>不支持</td><td>13</td><td>26</td><td>不支持</td></tr></thead></table><h2><a class="anchor" name="async-await%E5%AE%9E%E7%8E%B0"></a>async-await实现 <a class="hash-link" href="#async-await%E5%AE%9E%E7%8E%B0">#</a></h2><p>在es7草案中提出了async-await的异步解决方案。上述流程可以这样实现：</p><pre class="prism language-javascript">
<span class="token keyword">let</span> run <span class="token operator">=</span> async <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
   <span class="token comment" spellcheck="true"> // 0. 开始流程
</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> response <span class="token operator">=</span> await client<span class="token punctuation">.</span><span class="token function">createBucket<span class="token punctuation">(</span></span><span class="token string">&#x27;bucket-for-test&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment" spellcheck="true"> // 2. 完成bucket创建
</span>
        response <span class="token operator">=</span> await client<span class="token punctuation">.</span><span class="token function">putObjectFromString<span class="token punctuation">(</span></span><span class="token string">&#x27;bucket-for-test&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;test&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;hello world&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment" spellcheck="true"> // 3. 完成Object上传
</span>
        response <span class="token operator">=</span> await client<span class="token punctuation">.</span><span class="token function">deleteObject<span class="token punctuation">(</span></span><span class="token string">&#x27;bucket-for-test&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;test&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment" spellcheck="true"> // 4. 完成Object删除
</span>    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment" spellcheck="true"> // 异常处理
</span>    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">run<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">
// 1. 先执行其他代码，api操作异步执行</span></pre><p>整个过程跟Generator Function的方案很类似，似乎更简洁一点。不过需要通过try...catch来手动捕获异常。</p><h2><a class="anchor" name="javascript%E9%A2%84%E7%BC%96%E8%AF%91%E5%99%A8"></a>javascript预编译器 <a class="hash-link" href="#javascript%E9%A2%84%E7%BC%96%E8%AF%91%E5%99%A8">#</a></h2><p>为了能在浏览器端和Node.js端使用Generator Function和async-await特性，开发者可以使用javascript预编译器对代码进行处理，转成浏览器和Node.js中能够正常执行的版本。下面以<a href="http://babeljs.io/" target="_blank">babel</a>为例：</p><h3><a class="anchor" name="%E5%AE%89%E8%A3%85"></a>安装 <a class="hash-link" href="#%E5%AE%89%E8%A3%85">#</a></h3><p>在项目根目录下执行：</p><pre class="prism language-javascript">
npm install <span class="token operator">--</span>save babel<span class="token operator">-</span>core babel<span class="token operator">-</span>polyfill babel<span class="token operator">-</span>preset<span class="token operator">-</span>es2015 babel<span class="token operator">-</span>preset<span class="token operator">-</span>stage<span class="token number">-3</span>
npm install <span class="token operator">--</span>save<span class="token operator">-</span>dev babel<span class="token operator">-</span>cli
echo <span class="token string">&#x27;{ &quot;presets&quot;: [&quot;stage-3&quot;, &quot;es2015&quot;] }&#x27;</span> <span class="token operator">&gt;</span> <span class="token punctuation">.</span>babelrc</pre><h3><a class="anchor" name="%E7%BC%96%E8%AF%91"></a>编译 <a class="hash-link" href="#%E7%BC%96%E8%AF%91">#</a></h3><p>假设在original.js中使用了Generator Function和async-await特性，通过以下命令，可以生成compiled.js，这个js文件可以在浏览器端和Node.js端正常运行。</p><pre class="prism language-javascript">
babel original<span class="token punctuation">.</span>js <span class="token operator">-</span>o compiled<span class="token punctuation">.</span>js</pre><p>更多编译细节请参考<a href="http://babeljs.io/docs/usage/cli/" target="_blank">此文档</a>。</p></div><div class="docs-prevnext"><a class="docs-next" href="advanced-topics-postobject.html#content">下一篇 →</a></div></div></section><footer class="wrap"><div class="right">© 2016 Baidu Inc.</div></footer></div></body></html>