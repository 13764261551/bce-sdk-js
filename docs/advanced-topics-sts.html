<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><title>Baidu Cloud Engine JavaScript SDK</title><meta name="viewport" content="width=device-width"><link rel="stylesheet" href="/bce-sdk-js/css/draft.css"><script type="text/javascript" src="//use.typekit.net/vqa1hcx.js"></script><script type="text/javascript">try{Typekit.load();}catch(e){}</script></head><body><div class="container"><div class="nav-main"><div class="wrap"><a class="nav-home" href="/bce-sdk-js/">bce-sdk-js</a><ul class="nav-site"><li><a href="/bce-sdk-js/docs/overview.html#content" class="active">文档</a></li><li><a href="http://github.com/baidubce/bce-sdk-js" class="">源码</a></li><li><a href="https://bce.baidu.com/index.html" class="">百度开放云</a></li></ul></div></div><section class="content wrap documentationContent"><div class="nav-docs"><div class="nav-docs-section"><h3>API Reference</h3><ul><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/api-reference-cfc.html#content">CFC - api</a></li></ul></div></div><div class="inner-content"><a id="content"></a><h1>STS临时认证</h1><div><p>百度开放云SDK支持STS（Security Token Service）临时授权的方式。用这种方式可以从服务端生成一组具体特定操作权限、具有一定时效性的临时AK/SK。这组临时的AK/SK可以暴露给浏览器端直接使用。</p><p>关于STS方面的介绍请参考<a href="https://bce.baidu.com/doc/BOS/API.html#.E8.AE.BF.E9.97.AE.E6.8E.A7.E5.88.B6" target="_blank">此文档</a>。</p><p>使用STS比服务端签名更安全灵活，它可以对用户的使用权限进行灵活、精确地控制，而且不必像服务端签名需要每次请求都调用后端接口，在有效期内就可以不用再请求新的Security Token。</p><h3><a class="anchor" name="%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81"></a>实现代码 <a class="hash-link" href="#%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81">#</a></h3><h4><a class="anchor" name="dotnet%E6%9C%8D%E5%8A%A1%E7%AB%AF%E4%BB%A3%E7%A0%81"></a>DotNet服务端代码 <a class="hash-link" href="#dotnet%E6%9C%8D%E5%8A%A1%E7%AB%AF%E4%BB%A3%E7%A0%81">#</a></h4><blockquote><p>注意：<code>BceSdkDotNet.dll</code>的版本需要是<code>&gt;=1.0.2.0</code>，才可以使用 <code>StsClient</code></p></blockquote><pre class="prism language-javascript">
using System<span class="token punctuation">;</span>
using System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic<span class="token punctuation">;</span>
using System<span class="token punctuation">.</span>Linq<span class="token punctuation">;</span>
using System<span class="token punctuation">.</span>Web<span class="token punctuation">;</span>
using System<span class="token punctuation">.</span>Web<span class="token punctuation">.</span>Mvc<span class="token punctuation">;</span>
using BaiduBce<span class="token punctuation">;</span>
using BaiduBce<span class="token punctuation">.</span>Auth<span class="token punctuation">;</span>
using BaiduBce<span class="token punctuation">.</span>Services<span class="token punctuation">.</span>Sts<span class="token punctuation">;</span>
using BaiduBce<span class="token punctuation">.</span>Services<span class="token punctuation">.</span>Sts<span class="token punctuation">.</span>Model<span class="token punctuation">;</span>
using Newtonsoft<span class="token punctuation">.</span>Json<span class="token punctuation">;</span>

namespace BaiduCloudEngine<span class="token punctuation">.</span>Controllers
<span class="token punctuation">{</span>
    public class <span class="token class-name">StsController</span> <span class="token punctuation">:</span> Controller
    <span class="token punctuation">{</span>
        public string <span class="token function">Index<span class="token punctuation">(</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            string ak <span class="token operator">=</span> <span class="token string">&quot;&lt;your ak&gt;&quot;</span><span class="token punctuation">;</span>
            string sk <span class="token operator">=</span> <span class="token string">&quot;&lt;your sk&gt;&quot;</span><span class="token punctuation">;</span>
            string bucket <span class="token operator">=</span> <span class="token string">&quot;&lt;your bucket name&gt;&quot;</span><span class="token punctuation">;</span>

            BceClientConfiguration config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BceClientConfiguration</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Credentials <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultBceCredentials</span> <span class="token punctuation">(</span>ak<span class="token punctuation">,</span> sk<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            StsClient client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StsClient</span> <span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
            string accessControlList <span class="token operator">=</span>
            <span class="token string">&quot;{\&quot;accessControlList\&quot;: [{\&quot;service\&quot;:\&quot;bce:bos\&quot;,&quot;</span> <span class="token operator">+</span>
              <span class="token string">&quot;\&quot;region\&quot;:\&quot;*\&quot;,&quot;</span> <span class="token operator">+</span>
              <span class="token string">&quot;\&quot;effect\&quot;:\&quot;Allow\&quot;,&quot;</span> <span class="token operator">+</span>
              <span class="token string">&quot;\&quot;resource\&quot;:[\&quot;&quot;</span> <span class="token operator">+</span> bucket <span class="token operator">+</span> <span class="token string">&quot;/*\&quot;],&quot;</span> <span class="token operator">+</span>
              <span class="token string">&quot;\&quot;permission\&quot;:[\&quot;WRITE\&quot;]&quot;</span> <span class="token operator">+</span>
              <span class="token string">&quot;}]}&quot;</span><span class="token punctuation">;</span>
            GetSessionTokenRequest request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetSessionTokenRequest</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                DurationSeconds <span class="token operator">=</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true"> // One day
</span>                AccessControlList <span class="token operator">=</span> accessControlList
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            GetSessionTokenResponse response <span class="token operator">=</span> client<span class="token punctuation">.</span>GetSessionToken <span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token comment" spellcheck="true"> // response.AccessKeyId
</span>           <span class="token comment" spellcheck="true"> // response.SecretAccessKey
</span>           <span class="token comment" spellcheck="true"> // response.SessionToken
</span>            <span class="token keyword">return</span> JsonConvert<span class="token punctuation">.</span>SerializeObject <span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></pre><h4><a class="anchor" name="nodejs%E6%9C%8D%E5%8A%A1%E7%AB%AF%E4%BB%A3%E7%A0%81"></a>nodejs服务端代码 <a class="hash-link" href="#nodejs%E6%9C%8D%E5%8A%A1%E7%AB%AF%E4%BB%A3%E7%A0%81">#</a></h4><pre class="prism language-javascript">
<span class="token keyword">var</span> koa <span class="token operator">=</span> <span class="token function">require<span class="token punctuation">(</span></span><span class="token string">&#x27;koa&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> logger <span class="token operator">=</span> <span class="token function">require<span class="token punctuation">(</span></span><span class="token string">&#x27;koa-logger&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> router <span class="token operator">=</span> <span class="token function">require<span class="token punctuation">(</span></span><span class="token string">&#x27;koa-router&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token function">koa<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> url <span class="token operator">=</span> <span class="token function">require<span class="token punctuation">(</span></span><span class="token string">&#x27;url&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> STS <span class="token operator">=</span> <span class="token function">require<span class="token punctuation">(</span></span><span class="token string">&#x27;bce-sdk-js&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>STS<span class="token punctuation">;</span>

<span class="token keyword">var</span> kCredentials <span class="token operator">=</span> <span class="token punctuation">{</span>
    ak<span class="token punctuation">:</span> <span class="token string">&#x27;您的AK&#x27;</span><span class="token punctuation">,</span>
    sk<span class="token punctuation">:</span> <span class="token string">&#x27;您的SK&#x27;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> kRegion <span class="token operator">=</span> <span class="token string">&#x27;bj&#x27;</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">safeParse<span class="token punctuation">(</span></span>text<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> JSON<span class="token punctuation">.</span><span class="token function">parse<span class="token punctuation">(</span></span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ex</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
app<span class="token punctuation">.</span><span class="token function">use<span class="token punctuation">(</span></span><span class="token function">logger<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

router
    <span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&#x27;/sts&#x27;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token operator">*</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">var</span> stsClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">STS</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            credentials<span class="token punctuation">:</span> kCredentials<span class="token punctuation">,</span>
            region<span class="token punctuation">:</span> kRegion<span class="token punctuation">,</span>
            protocol<span class="token punctuation">:</span> <span class="token string">&#x27;http&#x27;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> res <span class="token operator">=</span> yield stsClient<span class="token punctuation">.</span><span class="token function">getSessionToken<span class="token punctuation">(</span></span><span class="token number">6000</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
            accessControlList<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
                service<span class="token punctuation">:</span> <span class="token string">&#x27;bce:bos&#x27;</span><span class="token punctuation">,</span>
                resource<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&#x27;bce-javascript-sdk-demo-test&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                region<span class="token punctuation">:</span> <span class="token string">&#x27;*&#x27;</span><span class="token punctuation">,</span>
                effect<span class="token punctuation">:</span> <span class="token string">&#x27;Allow&#x27;</span><span class="token punctuation">,</span>
                permission<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&#x27;READ&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;WRITE&#x27;</span><span class="token punctuation">]</span>
            <span class="token punctuation">}</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>body <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">stringify<span class="token punctuation">(</span></span>res<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use<span class="token punctuation">(</span></span>router<span class="token punctuation">.</span><span class="token function">routes<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">use<span class="token punctuation">(</span></span>router<span class="token punctuation">.</span><span class="token function">allowedMethods<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen<span class="token punctuation">(</span></span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre><p>在服务器端，用与创建bosClient实例类似的方式创建一个stsClient实例。对于stsClient实例，主要有一个方法，那就是getSessionToken。这个方法接收两个参数，第一个参数是临时授权的有效期，以秒为单位；第二个单位是具体的权限控制，参见STS<a href="https://bce.baidu.com/doc/BOS/API.html#STS.20.E6.9C.8D.E5.8A.A1.E6.8E.A5.E5.8F.A3" target="_blank">服务接口文档</a>。</p><p>这个方法会异步访问sts授权服务器，返回一个promise对象。STS授权服务器会返回类似如下内容：</p><pre class="prism language-javascript">
<span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    body<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;accessKeyId&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;d87a16e5ce1d47c1917b38ed03fbb329&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;secretAccessKey&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;e9b6f59ce06c45cdaaea2296111dab46&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;sessionToken&quot;</span><span class="token punctuation">:</span> &quot;MjUzZjQzNTY4OTE0NDRkNjg3N2E4YzJhZTc4YmU5ZDh8AAAAABwCAAB<span class="token operator">/</span>HfHDVV2bu5xUf6rApt2YdSLG6<span class="token operator">+</span>21UTC62EHvIuiaamtuMQQKNkR9PU2NJGVbuWgBn8Ot0atk0HnWYQGgwgyew24HtbrX3GFiR<span class="token operator">/</span>cDymCowm0TI6OGq7k8pGuBiCczT8qZcarH7VdZBd1lkpYaXbtP7wQJqiochDXrswrCd<span class="token operator">+</span>J<span class="token operator">/</span>I2CeSQT6mJiMmvupUV06R89dWBL<span class="token operator">/</span>Vcu7JQpdYBk0d5cp2B<span class="token operator">+</span>gdaHddBobevlBmKQw50<span class="token operator">/</span>oOykJIuho4Wn7FgOGPMPdod0Pf0s7lW<span class="token operator">/</span>HgSnPOjZCgRl0pihs197rP3GWpnlJRyfdCY0g0GFG6T0<span class="token operator">/</span>FsqDbxbi8lWzF1QRTmJzzh2Tax8xoPFKGMbpnt<span class="token comment" spellcheck="true">p//vGP7oPYK1JoES34TjcdcZnLzIRnVIGaZAzmZMUhPEXE5RVX1w8jPEXMJJHSrFs3lJe13o9Dwg==&quot;,
</span>        <span class="token string">&quot;createTime&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;2016-02-16T14:01:29Z&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;expiration&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;2016-02-16T15:41:29Z&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;userId&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;5e433c4a8fe74765a7ec6fc147e25c80&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></pre><p>服务器端需要把<code>accessKeyId</code>、<code>secretAccessKey</code>、<code>sessionToken</code>三个字段下发给浏览器端。</p><h4><a class="anchor" name="%E6%B5%8F%E8%A7%88%E5%99%A8%E5%89%8D%E7%AB%AF%E4%BB%A3%E7%A0%81"></a>浏览器前端代码 <a class="hash-link" href="#%E6%B5%8F%E8%A7%88%E5%99%A8%E5%89%8D%E7%AB%AF%E4%BB%A3%E7%A0%81">#</a></h4><p>前端使用STS临时授权机制时，只需要在各个服务初始化的时候把上面所说的参数<code>accessKeyId</code>、<code>secretAccessKey</code>、<code>sessionToken</code>引入就可以了。以BOS为例：</p><pre class="prism language-javascript">
<span class="token keyword">var</span> bosConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
    credentials<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        ak<span class="token punctuation">:</span> <span class="token string">&#x27;{accessKeyId}&#x27;</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true"> // STS服务器下发的临时ak
</span>        sk<span class="token punctuation">:</span> <span class="token string">&#x27;{secretAccessKey}&#x27;</span><span class="token comment" spellcheck="true"> // STS服务器下发的临时sk
</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    sessionToken<span class="token punctuation">:</span> <span class="token string">&#x27;{sessionToken}&#x27;</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true"> // STS服务器下发的sessionToken
</span>    endpoint<span class="token punctuation">:</span> <span class="token string">&#x27;http://bos.bj.baidubce.com&#x27;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">baidubce<span class="token punctuation">.</span>sdk<span class="token punctuation">.</span>BosClient</span><span class="token punctuation">(</span>bosConfig<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></div><div class="docs-prevnext"><a class="docs-next" href="advanced-topics-multiupload.html#content">下一篇 →</a></div></div></section><footer class="wrap"><div class="right">© 2016 Baidu Inc.</div></footer></div></body></html>