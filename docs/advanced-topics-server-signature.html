<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><title>Baidu Cloud Engine JavaScript SDK</title><meta name="viewport" content="width=device-width"><link rel="stylesheet" href="/bce-sdk-js/css/draft.css"><script type="text/javascript" src="//use.typekit.net/vqa1hcx.js"></script><script type="text/javascript">try{Typekit.load();}catch(e){}</script></head><body><div class="container"><div class="nav-main"><div class="wrap"><a class="nav-home" href="/bce-sdk-js/">bce-sdk-js</a><ul class="nav-site"><li><a href="/bce-sdk-js/docs/overview.html#content" class="active">文档</a></li><li><a href="http://github.com/baidubce/bce-sdk-js" class="">源码</a></li><li><a href="https://bce.baidu.com/index.html" class="">百度开放云</a></li></ul></div></div><section class="content wrap documentationContent"><div class="nav-docs"><div class="nav-docs-section"><h3>Quick Start</h3><ul><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/overview.html#content">总览</a></li><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/quickstart-env-nodejs.html#content">Nodejs环境</a></li><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/quickstart-env-browser.html#content">浏览器环境</a></li></ul></div><div class="nav-docs-section"><h3>Advanced Topics</h3><ul><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/advanced-topics-basic-example-in-browser.html#content">在浏览器中直接上传文件到bos</a></li><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/advanced-topics-security-issue.html#content">AK和SK的安全性问题</a></li><li><a style="margin-left:0;" class="active" href="/bce-sdk-js/docs/advanced-topics-server-signature.html#content">服务端签名</a></li><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/advanced-topics-sts.html#content">STS临时认证</a></li><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/advanced-topics-multiupload.html#content">大文件分块上传</a></li><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/advanced-topics-uploader.html#content">bce bos uploader</a></li><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/advanced-topics-postobject.html#content">IE低版本的处理</a></li></ul></div><div class="nav-docs-section"><h3>API Reference</h3><ul><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/api-reference-bos.html#content">BOS - api</a></li><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/api-reference-vod.html#content">VOD - api</a></li></ul></div></div><div class="inner-content"><a id="content"></a><h1>服务端签名</h1><div><p>主要的实现原理是把需要签名的数据发送给服务端，主要是 <code>httpMethod</code>, <code>path</code>, <code>queries</code>, <code>headers</code>。
收到服务器返回生成的签名之后，我们把签名和要上传的文件发送给 BOS 的服务器。</p><p>这种方案的优点是：因为签名的过程在服务端动态完成的，因此不需要把 AK 和 SK 放到页面上，而且可以添加
自己额外的验证逻辑，比如用户是否登录了，不允许 DELETE 这个 <code>httpMethod</code> 之类的。缺点是每次签名
都需要跟服务器交互一次。</p><h3><a class="anchor" name=""></a>实现代码 <a class="hash-link" href="#">#</a></h3><p>服务端返回内容的格式如下：</p><pre class="prism language-javascript">
<span class="token punctuation">{</span>
  statusCode<span class="token punctuation">:</span> number<span class="token punctuation">,</span>
  signature<span class="token punctuation">:</span> string<span class="token punctuation">,</span>
  xbceDate<span class="token punctuation">:</span> string
<span class="token punctuation">}</span></pre><p>正常情况下，<code>statusCode</code>应该是<code>200</code></p><h4><a class="anchor" name="nodejs"></a>nodejs 后端示例 <a class="hash-link" href="#nodejs">#</a></h4><div><script src="https://gist.github.com/leeight/c7928d68aeef88c00f93.js"></script>

</div><h4><a class="anchor" name="c"></a>C# 后端实现 <a class="hash-link" href="#c">#</a></h4><div><script src="https://gist.github.com/leeight/2ff85e853c5472a4aa55.js"></script>

</div><h4><a class="anchor" name=""></a>浏览器前端实现 <a class="hash-link" href="#">#</a></h4><p>把签名的过程由后端完成，浏览器端需要更改签名过程。以下代码重写了sdk中签名的方式：</p><pre class="prism language-javascript">
<span class="token keyword">var</span> tokenUrl <span class="token operator">=</span> <span class="token string">&#x27;后端签名api&#x27;</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> bosConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
    endpoint<span class="token punctuation">:</span> <span class="token string">&#x27;http://bos.bj.baidubce.com&#x27;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">baidubce<span class="token punctuation">.</span>sdk<span class="token punctuation">.</span>BosClient</span><span class="token punctuation">(</span>bosConfig<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> bucket <span class="token operator">=</span> <span class="token string">&#x27;bce-javascript-sdk-demo-test&#x27;</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">
// 重写签名方法，改为从服务器获取签名
</span><span class="token comment" spellcheck="true">// 您的代码可以不与此相同，您可加入特定的控制逻辑，如是否允许删除？操作者是否已登录？
</span>client<span class="token punctuation">.</span>createSignature <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>_<span class="token punctuation">,</span> httpMethod<span class="token punctuation">,</span> path<span class="token punctuation">,</span> params<span class="token punctuation">,</span> headers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> deferred <span class="token operator">=</span> baidubce<span class="token punctuation">.</span>sdk<span class="token punctuation">.</span>Q<span class="token punctuation">.</span><span class="token function">defer<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    $<span class="token punctuation">.</span><span class="token function">ajax<span class="token punctuation">(</span></span><span class="token punctuation">{</span>
        url<span class="token punctuation">:</span> tokenUrl<span class="token punctuation">,</span>
        dataType<span class="token punctuation">:</span> <span class="token string">&#x27;json&#x27;</span><span class="token punctuation">,</span>
        data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            httpMethod<span class="token punctuation">:</span> httpMethod<span class="token punctuation">,</span>
            path<span class="token punctuation">:</span> path<span class="token punctuation">,</span>
            params<span class="token punctuation">:</span> JSON<span class="token punctuation">.</span><span class="token function">stringify<span class="token punctuation">(</span></span>params <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            headers<span class="token punctuation">:</span> JSON<span class="token punctuation">.</span><span class="token function">stringify<span class="token punctuation">(</span></span>headers <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        success<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>payload<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>payload<span class="token punctuation">.</span>statusCode <span class="token operator">===</span> <span class="token number">200</span> &amp;&amp; payload<span class="token punctuation">.</span>signature<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                deferred<span class="token punctuation">.</span><span class="token function">resolve<span class="token punctuation">(</span></span>payload<span class="token punctuation">.</span>signature<span class="token punctuation">,</span> payload<span class="token punctuation">.</span>xbceDate<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                deferred<span class="token punctuation">.</span><span class="token function">reject<span class="token punctuation">(</span></span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&#x27;createSignature failed, statusCode = &#x27;</span> <span class="token operator">+</span> payload<span class="token punctuation">.</span>statusCode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> deferred<span class="token punctuation">.</span>promise<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


$<span class="token punctuation">(</span><span class="token string">&#x27;#upload&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on<span class="token punctuation">(</span></span><span class="token string">&#x27;change&#x27;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>evt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> file <span class="token operator">=</span> evt<span class="token punctuation">.</span>target<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> key <span class="token operator">=</span> file<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
    <span class="token keyword">var</span> blob <span class="token operator">=</span> file<span class="token punctuation">;</span>
    <span class="token keyword">var</span> id <span class="token operator">=</span> <span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> ext <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">split<span class="token punctuation">(</span></span><span class="token regex">/\./g</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pop<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> mimeType <span class="token operator">=</span> sdk<span class="token punctuation">.</span>MimeType<span class="token punctuation">.</span><span class="token function">guess<span class="token punctuation">(</span></span>ext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">/</span><span class="token operator">^</span>text<span class="token comment" spellcheck="true">\//.test(mimeType)) {
</span>        mimeType <span class="token operator">+</span><span class="token operator">=</span> <span class="token string">&#x27;; charset=UTF-8&#x27;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">var</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">&#x27;Content-Type&#x27;</span><span class="token punctuation">:</span> mimeType
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

   <span class="token comment" spellcheck="true"> // 以下逻辑与基本示例中的相同
</span>    <span class="token keyword">var</span> promise <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">putObjectFromBlob<span class="token punctuation">(</span></span>bucket<span class="token punctuation">,</span> key<span class="token punctuation">,</span> blob<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    client<span class="token punctuation">.</span><span class="token function">on<span class="token punctuation">(</span></span><span class="token string">&#x27;progress&#x27;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>evt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment" spellcheck="true"> // 上传中
</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    promise<span class="token punctuation">.</span><span class="token function">then<span class="token punctuation">(</span></span><span class="token keyword">function</span> <span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token comment" spellcheck="true"> // 上传成功
</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token comment" spellcheck="true"> // 上传失败
</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></div><div class="docs-prevnext"><a class="docs-next" href="advanced-topics-sts.html#content">下一篇 →</a></div></div></section><footer class="wrap"><div class="right">© 2016 Baidu Inc.</div></footer></div></body></html>