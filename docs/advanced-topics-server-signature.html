<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><title>Baidu Cloud Engine JavaScript SDK</title><meta name="viewport" content="width=device-width"><link rel="stylesheet" href="/bce-sdk-js/css/draft.css"><script type="text/javascript" src="//use.typekit.net/vqa1hcx.js"></script><script type="text/javascript">try{Typekit.load();}catch(e){}</script></head><body><div class="container"><div class="nav-main"><div class="wrap"><a class="nav-home" href="/bce-sdk-js/">bce-sdk-js</a><ul class="nav-site"><li><a href="/bce-sdk-js/docs/overview.html#content" class="active">文档</a></li><li><a href="http://github.com/baidubce/bce-sdk-js" class="">源码</a></li><li><a href="https://bce.baidu.com/index.html" class="">百度开放云</a></li></ul></div></div><section class="content wrap documentationContent"><div class="nav-docs"><div class="nav-docs-section"><h3>Quick Start</h3><ul><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/overview.html#content">总览</a></li><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/quickstart-env-nodejs.html#content">Nodejs环境</a></li><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/quickstart-env-browser.html#content">浏览器环境</a></li></ul></div><div class="nav-docs-section"><h3>Advanced Topics</h3><ul><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/advanced-topics-basic-example-in-browser.html#content">在浏览器中直接上传文件到bos</a></li><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/advanced-topics-security-issue.html#content">AK和SK的安全性问题</a></li><li><a style="margin-left:0;" class="active" href="/bce-sdk-js/docs/advanced-topics-server-signature.html#content">服务端签名</a></li><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/advanced-topics-sts.html#content">STS临时认证</a></li><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/advanced-topics-multiupload.html#content">大文件分块上传</a></li><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/advanced-topics-resume.html#content">分块上传进阶 - “断点续传”</a></li><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/advanced-topics-uploader.html#content">bce bos uploader</a></li><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/advanced-topics-programming-style.html#content">多种异步编程风格</a></li><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/advanced-topics-postobject.html#content">IE低版本的处理</a></li></ul></div><div class="nav-docs-section"><h3>API Reference</h3><ul><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/api-reference-bos.html#content">BOS - api</a></li><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/api-reference-vod.html#content">VOD - api</a></li></ul></div></div><div class="inner-content"><a id="content"></a><h1>服务端签名</h1><div><p>主要的实现原理是把需要签名的数据发送给服务端，主要是 <code>httpMethod</code>, <code>path</code>, <code>queries</code>, <code>headers</code>。
收到服务器返回生成的签名之后，我们把签名和要上传的文件发送给 BOS 的服务器。</p><p>这种方案的优点是：因为签名的过程在服务端动态完成的，因此不需要把 AK 和 SK 放到页面上，而且可以添加
自己额外的验证逻辑，比如用户是否登录了，不允许 DELETE 这个 <code>httpMethod</code> 之类的。缺点是每次签名
都需要跟服务器交互一次。</p><h3><a class="anchor" name="%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81"></a>实现代码 <a class="hash-link" href="#%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81">#</a></h3><h4><a class="anchor" name="nodejs%20%E5%90%8E%E7%AB%AF%E7%A4%BA%E4%BE%8B"></a>nodejs 后端示例 <a class="hash-link" href="#nodejs%20%E5%90%8E%E7%AB%AF%E7%A4%BA%E4%BE%8B">#</a></h4><pre class="prism language-javascript">
<span class="token keyword">var</span> http <span class="token operator">=</span> <span class="token function">require<span class="token punctuation">(</span></span><span class="token string">&#x27;http&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> url <span class="token operator">=</span> <span class="token function">require<span class="token punctuation">(</span></span><span class="token string">&#x27;url&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> util <span class="token operator">=</span> <span class="token function">require<span class="token punctuation">(</span></span><span class="token string">&#x27;util&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> sdk <span class="token operator">=</span> <span class="token function">require<span class="token punctuation">(</span></span><span class="token string">&#x27;bce-sdk-js&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> kCredentials <span class="token operator">=</span> <span class="token punctuation">{</span>
    ak<span class="token punctuation">:</span> <span class="token string">&#x27;&lt;your ak&gt;&#x27;</span><span class="token punctuation">,</span>
    sk<span class="token punctuation">:</span> <span class="token string">&#x27;&lt;your sk&gt;&#x27;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">safeParse<span class="token punctuation">(</span></span>text<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> JSON<span class="token punctuation">.</span><span class="token function">parse<span class="token punctuation">(</span></span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ex</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">buildStsResponse<span class="token punctuation">(</span></span>sts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> stsClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">sdk<span class="token punctuation">.</span>STS</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        credentials<span class="token punctuation">:</span> kCredentials<span class="token punctuation">,</span>
        region<span class="token punctuation">:</span> <span class="token string">&#x27;bj&#x27;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> stsClient<span class="token punctuation">.</span><span class="token function">getSessionToken<span class="token punctuation">(</span></span><span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span><span class="token punctuation">,</span> <span class="token function">safeParse<span class="token punctuation">(</span></span>sts<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then<span class="token punctuation">(</span></span><span class="token keyword">function</span> <span class="token punctuation">(</span>response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> body <span class="token operator">=</span> response<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            AccessKeyId<span class="token punctuation">:</span> body<span class="token punctuation">.</span>accessKeyId<span class="token punctuation">,</span>
            SecretAccessKey<span class="token punctuation">:</span> body<span class="token punctuation">.</span>secretAccessKey<span class="token punctuation">,</span>
            SessionToken<span class="token punctuation">:</span> body<span class="token punctuation">.</span>sessionToken<span class="token punctuation">,</span>
            Expiration<span class="token punctuation">:</span> body<span class="token punctuation">.</span>expiration
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">buildPolicyResponse<span class="token punctuation">(</span></span>policy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> auth <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">sdk<span class="token punctuation">.</span>Auth</span><span class="token punctuation">(</span>kCredentials<span class="token punctuation">.</span>ak<span class="token punctuation">,</span> kCredentials<span class="token punctuation">.</span>sk<span class="token punctuation">)</span><span class="token punctuation">;</span>
    policy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Buffer</span><span class="token punctuation">(</span>policy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString<span class="token punctuation">(</span></span><span class="token string">&#x27;base64&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    signature <span class="token operator">=</span> auth<span class="token punctuation">.</span><span class="token function">hash<span class="token punctuation">(</span></span>policy<span class="token punctuation">,</span> kCredentials<span class="token punctuation">.</span>sk<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> sdk<span class="token punctuation">.</span>Q<span class="token punctuation">.</span><span class="token function">resolve<span class="token punctuation">(</span></span><span class="token punctuation">{</span>
        accessKey<span class="token punctuation">:</span> kCredentials<span class="token punctuation">.</span>ak<span class="token punctuation">,</span>
        policy<span class="token punctuation">:</span> policy<span class="token punctuation">,</span>
        signature<span class="token punctuation">:</span> signature
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">buildNormalResponse<span class="token punctuation">(</span></span>query<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>query<span class="token punctuation">.</span>httpMethod &amp;&amp; query<span class="token punctuation">.</span>path &amp;&amp; query<span class="token punctuation">.</span>params &amp;&amp; query<span class="token punctuation">.</span>headers<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> sdk<span class="token punctuation">.</span>Q<span class="token punctuation">.</span><span class="token function">resolve<span class="token punctuation">(</span></span><span class="token punctuation">{</span>statusCode<span class="token punctuation">:</span> <span class="token number">403</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>query<span class="token punctuation">.</span>httpMethod <span class="token operator">!</span><span class="token operator">==</span> <span class="token string">&#x27;PUT&#x27;</span> &amp;&amp; query<span class="token punctuation">.</span>httpMethod <span class="token operator">!</span><span class="token operator">==</span> <span class="token string">&#x27;POST&#x27;</span> &amp;&amp; query<span class="token punctuation">.</span>httpMethod <span class="token operator">!</span><span class="token operator">==</span> <span class="token string">&#x27;GET&#x27;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment" spellcheck="true"> // 只允许 PUT/POST/GET Method
</span>        <span class="token keyword">return</span> sdk<span class="token punctuation">.</span>Q<span class="token punctuation">.</span><span class="token function">resolve<span class="token punctuation">(</span></span><span class="token punctuation">{</span>statusCode<span class="token punctuation">:</span> <span class="token number">403</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">var</span> httpMethod <span class="token operator">=</span> query<span class="token punctuation">.</span>httpMethod<span class="token punctuation">;</span>
    <span class="token keyword">var</span> path <span class="token operator">=</span> query<span class="token punctuation">.</span>path<span class="token punctuation">;</span>
    <span class="token keyword">var</span> params <span class="token operator">=</span> <span class="token function">safeParse<span class="token punctuation">(</span></span>query<span class="token punctuation">.</span>queries<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> headers <span class="token operator">=</span> <span class="token function">safeParse<span class="token punctuation">(</span></span>query<span class="token punctuation">.</span>headers<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> auth <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">sdk<span class="token punctuation">.</span>Auth</span><span class="token punctuation">(</span>kCredentials<span class="token punctuation">.</span>ak<span class="token punctuation">,</span> kCredentials<span class="token punctuation">.</span>sk<span class="token punctuation">)</span><span class="token punctuation">;</span>
    signature <span class="token operator">=</span> auth<span class="token punctuation">.</span><span class="token function">generateAuthorization<span class="token punctuation">(</span></span>httpMethod<span class="token punctuation">,</span> path<span class="token punctuation">,</span> params<span class="token punctuation">,</span> headers<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> sdk<span class="token punctuation">.</span>Q<span class="token punctuation">.</span><span class="token function">resolve<span class="token punctuation">(</span></span><span class="token punctuation">{</span>
        statusCode<span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
        signature<span class="token punctuation">:</span> signature<span class="token punctuation">,</span>
        xbceDate<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toISOString<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace<span class="token punctuation">(</span></span><span class="token regex">/\.\d+Z$/</span><span class="token punctuation">,</span> <span class="token string">&#x27;Z&#x27;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

http<span class="token punctuation">.</span><span class="token function">createServer<span class="token punctuation">(</span></span><span class="token keyword">function</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log<span class="token punctuation">(</span></span>req<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> query <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">parse<span class="token punctuation">(</span></span>req<span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span>query<span class="token punctuation">;</span>

    <span class="token keyword">var</span> promise <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>query<span class="token punctuation">.</span>sts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        promise <span class="token operator">=</span> <span class="token function">buildStsResponse<span class="token punctuation">(</span></span>query<span class="token punctuation">.</span>sts<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>query<span class="token punctuation">.</span>policy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        promise <span class="token operator">=</span> <span class="token function">buildPolicyResponse<span class="token punctuation">(</span></span>query<span class="token punctuation">.</span>policy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        promise <span class="token operator">=</span> <span class="token function">buildNormalResponse<span class="token punctuation">(</span></span>query<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    promise<span class="token punctuation">.</span><span class="token function">then<span class="token punctuation">(</span></span><span class="token keyword">function</span> <span class="token punctuation">(</span>payload<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">writeHead<span class="token punctuation">(</span></span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
            <span class="token string">&#x27;Content-Type&#x27;</span><span class="token punctuation">:</span> <span class="token string">&#x27;text/javascript; charset=utf-8&#x27;</span><span class="token punctuation">,</span>
            <span class="token string">&#x27;Access-Control-Allow-Origin&#x27;</span><span class="token punctuation">:</span> <span class="token string">&#x27;*&#x27;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>query<span class="token punctuation">.</span>callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            res<span class="token punctuation">.</span><span class="token function">end<span class="token punctuation">(</span></span>util<span class="token punctuation">.</span><span class="token function">format<span class="token punctuation">(</span></span><span class="token string">&#x27;%s(%s)&#x27;</span><span class="token punctuation">,</span> query<span class="token punctuation">.</span>callback<span class="token punctuation">,</span> JSON<span class="token punctuation">.</span><span class="token function">stringify<span class="token punctuation">(</span></span>payload<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            res<span class="token punctuation">.</span><span class="token function">end<span class="token punctuation">(</span></span>JSON<span class="token punctuation">.</span><span class="token function">stringify<span class="token punctuation">(</span></span>payload<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen<span class="token punctuation">(</span></span><span class="token number">1337</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log<span class="token punctuation">(</span></span><span class="token string">&#x27;Server running at http://0.0.0.0:1337/&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre><h4><a class="anchor" name="c#%20%E5%90%8E%E7%AB%AF%E5%AE%9E%E7%8E%B0"></a>C# 后端实现 <a class="hash-link" href="#c#%20%E5%90%8E%E7%AB%AF%E5%AE%9E%E7%8E%B0">#</a></h4><pre class="prism language-javascript">
using System<span class="token punctuation">;</span>
using System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic<span class="token punctuation">;</span>
using System<span class="token punctuation">.</span>Linq<span class="token punctuation">;</span>
using System<span class="token punctuation">.</span>Web<span class="token punctuation">;</span>
using System<span class="token punctuation">.</span>Web<span class="token punctuation">.</span>Mvc<span class="token punctuation">;</span>
using System<span class="token punctuation">.</span>Web<span class="token punctuation">.</span>Mvc<span class="token punctuation">.</span>Ajax<span class="token punctuation">;</span>
using BaiduBce<span class="token punctuation">;</span>
using BaiduBce<span class="token punctuation">.</span>Auth<span class="token punctuation">;</span>
using BaiduBce<span class="token punctuation">.</span>Internal<span class="token punctuation">;</span>
using Newtonsoft<span class="token punctuation">.</span>Json<span class="token punctuation">;</span>
using BaiduBce<span class="token punctuation">.</span>Util<span class="token punctuation">;</span>
using System<span class="token punctuation">.</span>Text<span class="token punctuation">;</span>
using System<span class="token punctuation">.</span>Security<span class="token punctuation">.</span>Cryptography<span class="token punctuation">;</span>
using BaiduBce<span class="token punctuation">.</span>Services<span class="token punctuation">.</span>Sts<span class="token punctuation">;</span>
using BaiduBce<span class="token punctuation">.</span>Services<span class="token punctuation">.</span>Sts<span class="token punctuation">.</span>Model<span class="token punctuation">;</span>

namespace BaiduCloudEngine<span class="token punctuation">.</span>Controllers
<span class="token punctuation">{</span>
  class <span class="token class-name">SignatureResult</span>
  <span class="token punctuation">{</span>
    public int statusCode <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    public string signature <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    public string xbceDate <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  class <span class="token class-name">PolicySignatureResult</span>
  <span class="token punctuation">{</span>
    public string policy <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    public string signature <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    public string accessKey <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  public class <span class="token class-name">HomeController</span> <span class="token punctuation">:</span> Controller
  <span class="token punctuation">{</span>
    private static string EncodeHex <span class="token punctuation">(</span>byte<span class="token punctuation">[</span><span class="token punctuation">]</span> data<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token keyword">var</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      foreach <span class="token punctuation">(</span><span class="token keyword">var</span> b <span class="token keyword">in</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sb<span class="token punctuation">.</span>Append <span class="token punctuation">(</span>BceV1Signer<span class="token punctuation">.</span>HexTable <span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> sb<span class="token punctuation">.</span>ToString <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    public string Index <span class="token punctuation">(</span>string httpMethod<span class="token punctuation">,</span> string path<span class="token punctuation">,</span> string queries<span class="token punctuation">,</span> string headers<span class="token punctuation">,</span> string policy<span class="token punctuation">,</span> string sts<span class="token punctuation">,</span> string callback<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      string ak <span class="token operator">=</span> <span class="token string">&quot;&lt;your ak&gt;&quot;</span><span class="token punctuation">;</span>
      string sk <span class="token operator">=</span> <span class="token string">&quot;&lt;your sk&gt;&quot;</span><span class="token punctuation">;</span>
      BceClientConfiguration config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BceClientConfiguration</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Credentials <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultBceCredentials</span> <span class="token punctuation">(</span>ak<span class="token punctuation">,</span> sk<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>

      string result <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>sts <span class="token operator">!</span><span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        StsClient client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StsClient</span> <span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
        string accessControlList <span class="token operator">=</span> sts<span class="token punctuation">;</span>
        GetSessionTokenRequest request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetSessionTokenRequest</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          DurationSeconds <span class="token operator">=</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span><span class="token punctuation">,</span>
          AccessControlList <span class="token operator">=</span> accessControlList
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        GetSessionTokenResponse response <span class="token operator">=</span> client<span class="token punctuation">.</span>GetSessionToken <span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        result <span class="token operator">=</span> JsonConvert<span class="token punctuation">.</span>SerializeObject <span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>policy <span class="token operator">!</span><span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        string base64 <span class="token operator">=</span> Convert<span class="token punctuation">.</span>ToBase64String <span class="token punctuation">(</span>Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span>GetBytes <span class="token punctuation">(</span>policy<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> hash <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HMACSHA256</span> <span class="token punctuation">(</span>Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span>GetBytes <span class="token punctuation">(</span>sk<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        string signature <span class="token operator">=</span> EncodeHex <span class="token punctuation">(</span>hash<span class="token punctuation">.</span>ComputeHash <span class="token punctuation">(</span>Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span>GetBytes <span class="token punctuation">(</span>base64<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result <span class="token operator">=</span> JsonConvert<span class="token punctuation">.</span>SerializeObject <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PolicySignatureResult</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          policy <span class="token operator">=</span> base64<span class="token punctuation">,</span>
          signature <span class="token operator">=</span> signature<span class="token punctuation">,</span>
          accessKey <span class="token operator">=</span> ak<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        InternalRequest internalRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InternalRequest</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        internalRequest<span class="token punctuation">.</span>Config <span class="token operator">=</span> config<span class="token punctuation">;</span>
        internalRequest<span class="token punctuation">.</span>Uri <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uri</span> <span class="token punctuation">(</span><span class="token string">&quot;http://www.baidu.com&quot;</span> <span class="token operator">+</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        internalRequest<span class="token punctuation">.</span>HttpMethod <span class="token operator">=</span> httpMethod<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>headers <span class="token operator">!</span><span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          internalRequest<span class="token punctuation">.</span>Headers <span class="token operator">=</span> JsonConvert<span class="token punctuation">.</span>DeserializeObject&lt;Dictionary&lt;string<span class="token punctuation">,</span> string<span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>headers<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>queries <span class="token operator">!</span><span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          internalRequest<span class="token punctuation">.</span>Parameters <span class="token operator">=</span> JsonConvert<span class="token punctuation">.</span>DeserializeObject&lt;Dictionary&lt;string<span class="token punctuation">,</span> string<span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>queries<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        BceV1Signer bceV1Signer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BceV1Signer</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        string sign <span class="token operator">=</span> bceV1Signer<span class="token punctuation">.</span>Sign <span class="token punctuation">(</span>internalRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>

        string xbceDate <span class="token operator">=</span> DateUtils<span class="token punctuation">.</span>FormatAlternateIso8601Date <span class="token punctuation">(</span>DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">)</span><span class="token punctuation">;</span>
        result <span class="token operator">=</span> JsonConvert<span class="token punctuation">.</span>SerializeObject <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SignatureResult</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          statusCode <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">,</span>
          signature <span class="token operator">=</span> sign<span class="token punctuation">,</span>
          xbceDate <span class="token operator">=</span> xbceDate<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>callback <span class="token operator">!</span><span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        result <span class="token operator">=</span> callback <span class="token operator">+</span> <span class="token string">&quot;(&quot;</span> <span class="token operator">+</span> result <span class="token operator">+</span> <span class="token string">&quot;)&quot;</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></pre><h4><a class="anchor" name="java%20%E5%90%8E%E7%AB%AF%E5%AE%9E%E7%8E%B0"></a>Java 后端实现 <a class="hash-link" href="#java%20%E5%90%8E%E7%AB%AF%E5%AE%9E%E7%8E%B0">#</a></h4><pre class="prism language-javascript">
package com<span class="token punctuation">.</span>baidu<span class="token punctuation">.</span>inf<span class="token punctuation">.</span>bce<span class="token punctuation">;</span>

import java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>IOException<span class="token punctuation">;</span>
import java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>UnsupportedEncodingException<span class="token punctuation">;</span>
import java<span class="token punctuation">.</span>net<span class="token punctuation">.</span>URI<span class="token punctuation">;</span>
import java<span class="token punctuation">.</span>net<span class="token punctuation">.</span>URISyntaxException<span class="token punctuation">;</span>
import java<span class="token punctuation">.</span>security<span class="token punctuation">.</span>InvalidKeyException<span class="token punctuation">;</span>
import java<span class="token punctuation">.</span>security<span class="token punctuation">.</span>NoSuchAlgorithmException<span class="token punctuation">;</span>
import java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Date<span class="token punctuation">;</span>
import java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Iterator<span class="token punctuation">;</span>
import java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Map<span class="token punctuation">;</span>

import javax<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>Mac<span class="token punctuation">;</span>
import javax<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>spec<span class="token punctuation">.</span>SecretKeySpec<span class="token punctuation">;</span>

import org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>codec<span class="token punctuation">.</span>binary<span class="token punctuation">.</span>Base64<span class="token punctuation">;</span>
import org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>codec<span class="token punctuation">.</span>binary<span class="token punctuation">.</span>Hex<span class="token punctuation">;</span>

import com<span class="token punctuation">.</span>baidubce<span class="token punctuation">.</span>BceClientConfiguration<span class="token punctuation">;</span>
import com<span class="token punctuation">.</span>baidubce<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>BceCredentials<span class="token punctuation">;</span>
import com<span class="token punctuation">.</span>baidubce<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>BceV1Signer<span class="token punctuation">;</span>
import com<span class="token punctuation">.</span>baidubce<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>DefaultBceCredentials<span class="token punctuation">;</span>
import com<span class="token punctuation">.</span>baidubce<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>SignOptions<span class="token punctuation">;</span>
import com<span class="token punctuation">.</span>baidubce<span class="token punctuation">.</span>http<span class="token punctuation">.</span>Headers<span class="token punctuation">;</span>
import com<span class="token punctuation">.</span>baidubce<span class="token punctuation">.</span>http<span class="token punctuation">.</span>HttpMethodName<span class="token punctuation">;</span>
import com<span class="token punctuation">.</span>baidubce<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>InternalRequest<span class="token punctuation">;</span>
import com<span class="token punctuation">.</span>baidubce<span class="token punctuation">.</span>services<span class="token punctuation">.</span>sts<span class="token punctuation">.</span>StsClient<span class="token punctuation">;</span>
import com<span class="token punctuation">.</span>baidubce<span class="token punctuation">.</span>services<span class="token punctuation">.</span>sts<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Credentials<span class="token punctuation">;</span>
import com<span class="token punctuation">.</span>baidubce<span class="token punctuation">.</span>services<span class="token punctuation">.</span>sts<span class="token punctuation">.</span>model<span class="token punctuation">.</span>GetSessionTokenRequest<span class="token punctuation">;</span>
import com<span class="token punctuation">.</span>baidubce<span class="token punctuation">.</span>services<span class="token punctuation">.</span>sts<span class="token punctuation">.</span>model<span class="token punctuation">.</span>GetSessionTokenResponse<span class="token punctuation">;</span>
import com<span class="token punctuation">.</span>baidubce<span class="token punctuation">.</span>util<span class="token punctuation">.</span>DateUtils<span class="token punctuation">;</span>
import com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>core<span class="token punctuation">.</span>JsonParseException<span class="token punctuation">;</span>
import com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>databind<span class="token punctuation">.</span>JsonMappingException<span class="token punctuation">;</span>
import com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>databind<span class="token punctuation">.</span>ObjectMapper<span class="token punctuation">;</span>

class <span class="token class-name">MyInternalRequest</span> extends <span class="token class-name">InternalRequest</span> <span class="token punctuation">{</span>
    private boolean x <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    public <span class="token function">MyInternalRequest<span class="token punctuation">(</span></span>HttpMethodName httpMethod<span class="token punctuation">,</span> URI uri<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">super<span class="token punctuation">(</span></span>httpMethod<span class="token punctuation">,</span> uri<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    public void <span class="token function">addHeader<span class="token punctuation">(</span></span>String name<span class="token punctuation">,</span> String value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase<span class="token punctuation">(</span></span>Headers<span class="token punctuation">.</span>HOST<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token comment" spellcheck="true"> // Host只能被设置一次，绕过 BceV1Signer 里面的一个问题
</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            x <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        super<span class="token punctuation">.</span><span class="token function">addHeader<span class="token punctuation">(</span></span>name<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

public class <span class="token class-name">SignatureDemo</span> <span class="token punctuation">{</span>
    private static String AK <span class="token operator">=</span> <span class="token string">&quot;&lt;your ak&gt;&quot;</span><span class="token punctuation">;</span>
    private static String SK <span class="token operator">=</span> <span class="token string">&quot;&lt;your sk&gt;&quot;</span><span class="token punctuation">;</span>
    private static String STS_ENDPOINT <span class="token operator">=</span> <span class="token string">&quot;http://sts.bj.baidubce.com&quot;</span><span class="token punctuation">;</span>
    private static String UTF8 <span class="token operator">=</span> <span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">;</span>

    private boolean <span class="token function">isEmpty<span class="token punctuation">(</span></span>String x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> x <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> x<span class="token punctuation">.</span><span class="token function">length<span class="token punctuation">(</span></span><span class="token punctuation">)</span> &lt;<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    private String <span class="token function">getStsToken<span class="token punctuation">(</span></span>String sts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        BceCredentials credentials <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultBceCredentials</span><span class="token punctuation">(</span>AK<span class="token punctuation">,</span> SK<span class="token punctuation">)</span><span class="token punctuation">;</span>
        BceClientConfiguration config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BceClientConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">withEndpoint<span class="token punctuation">(</span></span>STS_ENDPOINT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withCredentials<span class="token punctuation">(</span></span>credentials<span class="token punctuation">)</span><span class="token punctuation">;</span>
        StsClient client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StsClient</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>

        GetSessionTokenRequest request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetSessionTokenRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span><span class="token function">setAcl<span class="token punctuation">(</span></span>sts<span class="token punctuation">)</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span><span class="token function">setDurationSeconds<span class="token punctuation">(</span></span><span class="token number">24</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        GetSessionTokenResponse response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">getSessionToken<span class="token punctuation">(</span></span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>

        String pattern <span class="token operator">=</span> <span class="token string">&quot;{&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;\&quot;AccessKeyId\&quot;:\&quot;%s\&quot;,&quot;</span>
                <span class="token operator">+</span> <span class="token string">&quot;\&quot;SecretAccessKey\&quot;: \&quot;%s\&quot;,&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;\&quot;SessionToken\&quot;: \&quot;%s\&quot;,&quot;</span>
                <span class="token operator">+</span> <span class="token string">&quot;\&quot;Expiration\&quot;: \&quot;%s\&quot;&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;}&quot;</span><span class="token punctuation">;</span>

        Credentials c <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getCredentials<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> String<span class="token punctuation">.</span><span class="token function">format<span class="token punctuation">(</span></span>pattern<span class="token punctuation">,</span> c<span class="token punctuation">.</span><span class="token function">getAccessKeyId<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                c<span class="token punctuation">.</span><span class="token function">getSecretAccessKey<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> c<span class="token punctuation">.</span><span class="token function">getSessionToken<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                DateUtils<span class="token punctuation">.</span><span class="token function">formatAlternateIso8601Date<span class="token punctuation">(</span></span>c<span class="token punctuation">.</span><span class="token function">getExpiration<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    private String <span class="token function">getPolicySignature<span class="token punctuation">(</span></span>String policy<span class="token punctuation">)</span>
            throws UnsupportedEncodingException<span class="token punctuation">,</span> NoSuchAlgorithmException<span class="token punctuation">,</span>
            InvalidKeyException <span class="token punctuation">{</span>
        String policyBase64 <span class="token operator">=</span> Base64<span class="token punctuation">.</span><span class="token function">encodeBase64String<span class="token punctuation">(</span></span>policy<span class="token punctuation">.</span><span class="token function">getBytes<span class="token punctuation">(</span></span>UTF8<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Mac mac <span class="token operator">=</span> Mac<span class="token punctuation">.</span><span class="token function">getInstance<span class="token punctuation">(</span></span><span class="token string">&quot;HmacSHA256&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mac<span class="token punctuation">.</span><span class="token function">init<span class="token punctuation">(</span></span><span class="token keyword">new</span> <span class="token class-name">SecretKeySpec</span><span class="token punctuation">(</span>SK<span class="token punctuation">.</span><span class="token function">getBytes<span class="token punctuation">(</span></span>UTF8<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;HmacSHA256&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String policySignature <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>Hex<span class="token punctuation">.</span><span class="token function">encodeHex<span class="token punctuation">(</span></span>mac
                <span class="token punctuation">.</span><span class="token function">doFinal<span class="token punctuation">(</span></span>policyBase64<span class="token punctuation">.</span><span class="token function">getBytes<span class="token punctuation">(</span></span>UTF8<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        String pattern <span class="token operator">=</span> <span class="token string">&quot;{&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;\&quot;policy\&quot;:\&quot;%s\&quot;,&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;\&quot;signature\&quot;: \&quot;%s\&quot;,&quot;</span>
                <span class="token operator">+</span> <span class="token string">&quot;\&quot;accessKey\&quot;: \&quot;%s\&quot;}&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> String<span class="token punctuation">.</span><span class="token function">format<span class="token punctuation">(</span></span>pattern<span class="token punctuation">,</span> policyBase64<span class="token punctuation">,</span> policySignature<span class="token punctuation">,</span> AK<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    private String <span class="token function">getNormalSignature<span class="token punctuation">(</span></span>String httpMethod<span class="token punctuation">,</span> String path<span class="token punctuation">,</span>
            String queries<span class="token punctuation">,</span> String headers<span class="token punctuation">)</span> throws URISyntaxException<span class="token punctuation">,</span>
            JsonParseException<span class="token punctuation">,</span> JsonMappingException<span class="token punctuation">,</span> IOException <span class="token punctuation">{</span>
        URI uri <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URI</span><span class="token punctuation">(</span><span class="token string">&quot;http://www.baidu.com&quot;</span> <span class="token operator">+</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        InternalRequest request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyInternalRequest</span><span class="token punctuation">(</span>
                HttpMethodName<span class="token punctuation">.</span><span class="token function">valueOf<span class="token punctuation">(</span></span>httpMethod<span class="token punctuation">)</span><span class="token punctuation">,</span> uri<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isEmpty<span class="token punctuation">(</span></span>headers<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ObjectMapper mapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Map&lt;<span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token operator">&gt;</span> map <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">readValue<span class="token punctuation">(</span></span>headers<span class="token punctuation">,</span> Map<span class="token punctuation">.</span>class<span class="token punctuation">)</span><span class="token punctuation">;</span>
            Iterator&lt;<span class="token operator">?</span><span class="token operator">&gt;</span> iterator <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">keySet<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">hasNext<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                String name <span class="token operator">=</span> <span class="token punctuation">(</span>String<span class="token punctuation">)</span> iterator<span class="token punctuation">.</span><span class="token function">next<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                String value <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                request<span class="token punctuation">.</span><span class="token function">addHeader<span class="token punctuation">(</span></span>name<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isEmpty<span class="token punctuation">(</span></span>queries<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ObjectMapper mapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Map&lt;<span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token operator">&gt;</span> map <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">readValue<span class="token punctuation">(</span></span>queries<span class="token punctuation">,</span> Map<span class="token punctuation">.</span>class<span class="token punctuation">)</span><span class="token punctuation">;</span>
            Iterator&lt;<span class="token operator">?</span><span class="token operator">&gt;</span> iterator <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">keySet<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">hasNext<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                String name <span class="token operator">=</span> <span class="token punctuation">(</span>String<span class="token punctuation">)</span> iterator<span class="token punctuation">.</span><span class="token function">next<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                String value <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                request<span class="token punctuation">.</span><span class="token function">addParameter<span class="token punctuation">(</span></span>name<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        SignOptions options <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SignOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        options<span class="token punctuation">.</span><span class="token function">setTimestamp<span class="token punctuation">(</span></span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        BceCredentials c <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultBceCredentials</span><span class="token punctuation">(</span>AK<span class="token punctuation">,</span> SK<span class="token punctuation">)</span><span class="token punctuation">;</span>
        BceV1Signer bceV1Signer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BceV1Signer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bceV1Signer<span class="token punctuation">.</span><span class="token function">sign<span class="token punctuation">(</span></span>request<span class="token punctuation">,</span> c<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
        String authorization <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeaders<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>Headers<span class="token punctuation">.</span>AUTHORIZATION<span class="token punctuation">)</span><span class="token punctuation">;</span>

        String xbceDate <span class="token operator">=</span> DateUtils<span class="token punctuation">.</span><span class="token function">formatAlternateIso8601Date<span class="token punctuation">(</span></span>options
                <span class="token punctuation">.</span><span class="token function">getTimestamp<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        String pattern <span class="token operator">=</span> <span class="token string">&quot;{&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;\&quot;statusCode\&quot;:200,&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;\&quot;signature\&quot;: \&quot;%s\&quot;,&quot;</span>
                <span class="token operator">+</span> <span class="token string">&quot;\&quot;xbceDate\&quot;: \&quot;%s\&quot;}&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> String<span class="token punctuation">.</span><span class="token function">format<span class="token punctuation">(</span></span>pattern<span class="token punctuation">,</span> authorization<span class="token punctuation">,</span> xbceDate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    public String <span class="token function">doIt<span class="token punctuation">(</span></span>String httpMethod<span class="token punctuation">,</span> String path<span class="token punctuation">,</span> String queries<span class="token punctuation">,</span>
            String headers<span class="token punctuation">,</span> String policy<span class="token punctuation">,</span> String sts<span class="token punctuation">,</span> String callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        String result <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isEmpty<span class="token punctuation">(</span></span>sts<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getStsToken<span class="token punctuation">(</span></span>sts<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isEmpty<span class="token punctuation">(</span></span>policy<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getPolicySignature<span class="token punctuation">(</span></span>policy<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InvalidKeyException</span> <span class="token operator">|</span> UnsupportedEncodingException
                    <span class="token operator">|</span> NoSuchAlgorithmException e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isEmpty<span class="token punctuation">(</span></span>httpMethod<span class="token punctuation">)</span> &amp;&amp; <span class="token operator">!</span><span class="token function">isEmpty<span class="token punctuation">(</span></span>path<span class="token punctuation">)</span> &amp;&amp; <span class="token operator">!</span><span class="token function">isEmpty<span class="token punctuation">(</span></span>headers<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getNormalSignature<span class="token punctuation">(</span></span>httpMethod<span class="token punctuation">,</span> path<span class="token punctuation">,</span> queries<span class="token punctuation">,</span>
                        headers<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">URISyntaxException</span> <span class="token operator">|</span> IOException e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            result <span class="token operator">=</span> <span class="token string">&quot;{\&quot;statusCode\&quot;: 403}&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isEmpty<span class="token punctuation">(</span></span>callback<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            result <span class="token operator">=</span> callback <span class="token operator">+</span> <span class="token string">&quot;(&quot;</span> <span class="token operator">+</span> result <span class="token operator">+</span> <span class="token string">&quot;)&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></pre><p>如何使用上面的<code>SignatureDemo</code>呢？我们可以基于<code>NanoHTTPD</code>开发一个简单的Web Server来处理这个事情：</p><pre class="prism language-javascript">
package com<span class="token punctuation">.</span>baidu<span class="token punctuation">.</span>inf<span class="token punctuation">.</span>bce<span class="token punctuation">;</span>

import java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>IOException<span class="token punctuation">;</span>
import java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Map<span class="token punctuation">;</span>

import fi<span class="token punctuation">.</span>iki<span class="token punctuation">.</span>elonen<span class="token punctuation">.</span>NanoHTTPD<span class="token punctuation">;</span>

public class <span class="token class-name">App</span> extends <span class="token class-name">NanoHTTPD</span> <span class="token punctuation">{</span>
    public <span class="token function">App<span class="token punctuation">(</span></span>int port<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">super<span class="token punctuation">(</span></span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    @Override
    public Response <span class="token function">serve<span class="token punctuation">(</span></span>IHTTPSession session<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Map&lt;String<span class="token punctuation">,</span> String<span class="token operator">&gt;</span> params <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">getParms<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String httpMethod <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;httpMethod&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String path <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;path&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String queries <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;queries&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String headers <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;headers&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String policy <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;policy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String sts <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;sts&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String callback <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;callback&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        String responseBody <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SignatureDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doIt<span class="token punctuation">(</span></span>httpMethod<span class="token punctuation">,</span> path<span class="token punctuation">,</span>
                queries<span class="token punctuation">,</span> headers<span class="token punctuation">,</span> policy<span class="token punctuation">,</span> sts<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Response response <span class="token operator">=</span> <span class="token function">newFixedLengthResponse<span class="token punctuation">(</span></span>responseBody<span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">addHeader<span class="token punctuation">(</span></span><span class="token string">&quot;Content-Type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;text/javascript&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> response<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    public static void <span class="token function">main<span class="token punctuation">(</span></span>String args<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> throws IOException <span class="token punctuation">{</span>
        App app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">App</span><span class="token punctuation">(</span><span class="token number">7788</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        app<span class="token punctuation">.</span><span class="token function">start<span class="token punctuation">(</span></span>NanoHTTPD<span class="token punctuation">.</span>SOCKET_READ_TIMEOUT<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></pre><h4><a class="anchor" name="%E6%B5%8F%E8%A7%88%E5%99%A8%E5%89%8D%E7%AB%AF%E5%AE%9E%E7%8E%B0"></a>浏览器前端实现 <a class="hash-link" href="#%E6%B5%8F%E8%A7%88%E5%99%A8%E5%89%8D%E7%AB%AF%E5%AE%9E%E7%8E%B0">#</a></h4><p>把签名的过程由后端完成，浏览器端需要更改签名过程。以下代码重写了sdk中签名的方式：</p><pre class="prism language-javascript">
<span class="token keyword">var</span> tokenUrl <span class="token operator">=</span> <span class="token string">&#x27;后端签名api&#x27;</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> bosConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
    endpoint<span class="token punctuation">:</span> <span class="token string">&#x27;http://bos.bj.baidubce.com&#x27;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">baidubce<span class="token punctuation">.</span>sdk<span class="token punctuation">.</span>BosClient</span><span class="token punctuation">(</span>bosConfig<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> bucket <span class="token operator">=</span> <span class="token string">&#x27;bce-javascript-sdk-demo-test&#x27;</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">
// 重写签名方法，改为从服务器获取签名
</span><span class="token comment" spellcheck="true">// 您的代码可以不与此相同，您可加入特定的控制逻辑，如是否允许删除？操作者是否已登录？
</span>client<span class="token punctuation">.</span>createSignature <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>_<span class="token punctuation">,</span> httpMethod<span class="token punctuation">,</span> path<span class="token punctuation">,</span> params<span class="token punctuation">,</span> headers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> deferred <span class="token operator">=</span> baidubce<span class="token punctuation">.</span>sdk<span class="token punctuation">.</span>Q<span class="token punctuation">.</span><span class="token function">defer<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    $<span class="token punctuation">.</span><span class="token function">ajax<span class="token punctuation">(</span></span><span class="token punctuation">{</span>
        url<span class="token punctuation">:</span> tokenUrl<span class="token punctuation">,</span>
        dataType<span class="token punctuation">:</span> <span class="token string">&#x27;json&#x27;</span><span class="token punctuation">,</span>
        data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            httpMethod<span class="token punctuation">:</span> httpMethod<span class="token punctuation">,</span>
            path<span class="token punctuation">:</span> path<span class="token punctuation">,</span>
            params<span class="token punctuation">:</span> JSON<span class="token punctuation">.</span><span class="token function">stringify<span class="token punctuation">(</span></span>params <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            headers<span class="token punctuation">:</span> JSON<span class="token punctuation">.</span><span class="token function">stringify<span class="token punctuation">(</span></span>headers <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        success<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>payload<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>payload<span class="token punctuation">.</span>statusCode <span class="token operator">===</span> <span class="token number">200</span> &amp;&amp; payload<span class="token punctuation">.</span>signature<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                deferred<span class="token punctuation">.</span><span class="token function">resolve<span class="token punctuation">(</span></span>payload<span class="token punctuation">.</span>signature<span class="token punctuation">,</span> payload<span class="token punctuation">.</span>xbceDate<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                deferred<span class="token punctuation">.</span><span class="token function">reject<span class="token punctuation">(</span></span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&#x27;createSignature failed, statusCode = &#x27;</span> <span class="token operator">+</span> payload<span class="token punctuation">.</span>statusCode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> deferred<span class="token punctuation">.</span>promise<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


$<span class="token punctuation">(</span><span class="token string">&#x27;#upload&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on<span class="token punctuation">(</span></span><span class="token string">&#x27;change&#x27;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>evt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> file <span class="token operator">=</span> evt<span class="token punctuation">.</span>target<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> key <span class="token operator">=</span> file<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
    <span class="token keyword">var</span> blob <span class="token operator">=</span> file<span class="token punctuation">;</span>
    <span class="token keyword">var</span> id <span class="token operator">=</span> <span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> ext <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">split<span class="token punctuation">(</span></span><span class="token regex">/\./g</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pop<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> mimeType <span class="token operator">=</span> sdk<span class="token punctuation">.</span>MimeType<span class="token punctuation">.</span><span class="token function">guess<span class="token punctuation">(</span></span>ext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">/</span><span class="token operator">^</span>text<span class="token comment" spellcheck="true">\//.test(mimeType)) {
</span>        mimeType <span class="token operator">+</span><span class="token operator">=</span> <span class="token string">&#x27;; charset=UTF-8&#x27;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">var</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">&#x27;Content-Type&#x27;</span><span class="token punctuation">:</span> mimeType
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

   <span class="token comment" spellcheck="true"> // 以下逻辑与基本示例中的相同
</span>    <span class="token keyword">var</span> promise <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">putObjectFromBlob<span class="token punctuation">(</span></span>bucket<span class="token punctuation">,</span> key<span class="token punctuation">,</span> blob<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    client<span class="token punctuation">.</span><span class="token function">on<span class="token punctuation">(</span></span><span class="token string">&#x27;progress&#x27;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>evt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment" spellcheck="true"> // 上传中
</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    promise<span class="token punctuation">.</span><span class="token function">then<span class="token punctuation">(</span></span><span class="token keyword">function</span> <span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token comment" spellcheck="true"> // 上传成功
</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token comment" spellcheck="true"> // 上传失败
</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></div><div class="docs-prevnext"><a class="docs-next" href="advanced-topics-sts.html#content">下一篇 →</a></div></div></section><footer class="wrap"><div class="right">© 2016 Baidu Inc.</div></footer></div></body></html>