<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><title>Baidu Cloud Engine JavaScript SDK</title><meta name="viewport" content="width=device-width"><link rel="stylesheet" href="/bce-sdk-js/css/draft.css"><script type="text/javascript" src="//use.typekit.net/vqa1hcx.js"></script><script type="text/javascript">try{Typekit.load();}catch(e){}</script></head><body><div class="container"><div class="nav-main"><div class="wrap"><a class="nav-home" href="/bce-sdk-js/">bce-sdk-js</a><ul class="nav-site"><li><a href="/bce-sdk-js/docs/overview.html#content" class="active">文档</a></li><li><a href="http://github.com/baidubce/bce-sdk-js" class="">源码</a></li><li><a href="https://bce.baidu.com/index.html" class="">百度开放云</a></li></ul></div></div><section class="content wrap documentationContent"><div class="nav-docs"><div class="nav-docs-section"><h3>Quick Start</h3><ul><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/overview.html#content">总览</a></li><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/quickstart-env-nodejs.html#content">Nodejs环境</a></li><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/quickstart-env-browser.html#content">浏览器环境</a></li></ul></div><div class="nav-docs-section"><h3>Advanced Topics</h3><ul><li><a style="margin-left:0;" class="active" href="/bce-sdk-js/docs/advanced-topics-basic-example-in-browser.html#content">在浏览器中直接上传文件到bos</a></li><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/advanced-topics-security-issue.html#content">AK和SK的安全性问题</a></li><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/advanced-topics-server-signature.html#content">服务端签名</a></li><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/advanced-topics-sts.html#content">STS临时认证</a></li><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/advanced-topics-multiupload.html#content">大文件分块上传</a></li><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/advanced-topics-uploader.html#content">bce bos uploader</a></li><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/advanced-topics-postobject.html#content">IE低版本的处理</a></li></ul></div><div class="nav-docs-section"><h3>API Reference</h3><ul><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/api-reference-bos.html#content">BOS - api</a></li><li><a style="margin-left:0;" class="" href="/bce-sdk-js/docs/api-reference-vod.html#content">VOD - api</a></li></ul></div></div><div class="inner-content"><a id="content"></a><h1>在浏览器中直接上传文件到bos</h1><div><p>这一小节将会指导您如何在浏览器中直接上传文件到BOS中。</p><h3><a class="anchor" name="bucket"></a>开启bucket的跨域访问 <a class="hash-link" href="#bucket">#</a></h3><p>受浏览器安全限制，如果想直接在浏览器中访问BOS服务，必须正确设置好相关bucket的跨域功能。设置方法如下：</p><ol><li>登录开放云控制台</li><li>选择一个 Bucket，进入 Bucket 管理页面</li><li>点击左侧『Bucket属性』，进入 Bucket 配置的页面</li><li>点击右侧『CORS设置』，进入 CORS设置 页面</li><li>点击『添加规则』按钮，可以添加一条或者多条CORS的规则</li></ol><p>如下图所示：</p><p><img src="http://google.bceimg.com/cors.png" alt=""></p><blockquote><p>注意：Origins里面的配置，不应该有最后的 &#x27;/&#x27;。例如：<a href="https://*.github.io/">https://*.github.io/</a> 是错误的配置</p></blockquote><h3><a class="anchor" name=""></a>初始化 <a class="hash-link" href="#">#</a></h3><pre class="prism language-javascript">
<span class="token keyword">var</span> bosConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
    credentials<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        ak<span class="token punctuation">:</span> <span class="token string">&#x27;从开放云控制台查询您的ak&#x27;</span><span class="token punctuation">,</span>
        sk<span class="token punctuation">:</span> <span class="token string">&#x27;从开放云控制台查询上面这个ak所对应的sk&#x27;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    endpoint<span class="token punctuation">:</span> <span class="token string">&#x27;http://bos.bj.baidubce.com&#x27;</span><span class="token comment" spellcheck="true"> // 根据您选用bos服务的区域配置相应的endpoint
</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> bucket <span class="token operator">=</span> <span class="token string">&#x27;bce-javascript-sdk-demo-test&#x27;</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true"> // 设置您想要操作的bucket
</span><span class="token keyword">var</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">baidubce<span class="token punctuation">.</span>sdk<span class="token punctuation">.</span>BosClient</span><span class="token punctuation">(</span>bosConfig<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre><p>后续我们可以使用client这个实例来进行bos相关操作。</p><h3><a class="anchor" name=""></a>上传逻辑 <a class="hash-link" href="#">#</a></h3><p>我们可以通过调用<code>client.putObjectFromBlob(bucket, key, blob, options)</code>来完成文件的上传操作。</p><p>这个函数支持4个参数，其中<code>options</code>是可选的。如果需要手工设置文件的的<code>Content-Type</code>，可以放到<code>options</code>参数里面。
如果没有手工设置，默认的<code>Content-Type</code>是<code>application/oceat-stream</code>。</p><p>另外，可以通过调用<code>baidubce.sdk.MimeType.guess(ext)</code>来根据后缀名得到一些常用的<code>Content-Type</code>。</p><blockquote><p>因为Firefox兼容性的一个问题，如果上传的文件是 <code>text/***</code> 类型，Firefox 会自动添加 <code>charset=utf-8</code>
因此我们给 options 设置 <code>Content-Type</code> 的时候，需要手工加上 <code>charset=utf-8</code>，否则会导致浏览器计算的签名跟服务器计算的签名不一致，导致上传失败</p></blockquote><pre class="prism language-javascript">
<span class="token comment" spellcheck="true">// 监听文件上传的事件，假设页面中有：&lt;input type=&quot;file&quot; id=&quot;upload&quot; /&gt;
</span>$<span class="token punctuation">(</span><span class="token string">&#x27;#upload&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on<span class="token punctuation">(</span></span><span class="token string">&#x27;change&#x27;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>evt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> file <span class="token operator">=</span> evt<span class="token punctuation">.</span>target<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true"> // 获取要上传的文件
</span>    <span class="token keyword">var</span> key <span class="token operator">=</span> file<span class="token punctuation">.</span>name<span class="token punctuation">;</span><span class="token comment" spellcheck="true"> // 保存到bos时的key，您可更改，默认以文件名作为key
</span>    <span class="token keyword">var</span> blob <span class="token operator">=</span> file<span class="token punctuation">;</span>

    <span class="token keyword">var</span> ext <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">split<span class="token punctuation">(</span></span><span class="token regex">/\./g</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pop<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> mimeType <span class="token operator">=</span> baidubce<span class="token punctuation">.</span>sdk<span class="token punctuation">.</span>MimeType<span class="token punctuation">.</span><span class="token function">guess<span class="token punctuation">(</span></span>ext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">/</span><span class="token operator">^</span>text<span class="token comment" spellcheck="true">\//.test(mimeType)) {
</span>        mimeType <span class="token operator">+</span><span class="token operator">=</span> <span class="token string">&#x27;; charset=UTF-8&#x27;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">var</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">&#x27;Content-Type&#x27;</span><span class="token punctuation">:</span> mimeType
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    client<span class="token punctuation">.</span><span class="token function">putObjectFromBlob<span class="token punctuation">(</span></span>bucket<span class="token punctuation">,</span> key<span class="token punctuation">,</span> blob<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then<span class="token punctuation">(</span></span><span class="token keyword">function</span> <span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token comment" spellcheck="true"> // 上传完成，添加您的代码
</span>            console<span class="token punctuation">.</span><span class="token function">log<span class="token punctuation">(</span></span><span class="token string">&#x27;上传成功&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token comment" spellcheck="true"> // 上传失败，添加您的代码
</span>            console<span class="token punctuation">.</span><span class="token function">error<span class="token punctuation">(</span></span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre><p>如果想获悉当前上传的进度，可以监听<code>progress</code>事件。</p><pre class="prism language-javascript">
client<span class="token punctuation">.</span><span class="token function">on<span class="token punctuation">(</span></span><span class="token string">&#x27;progress&#x27;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>evt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment" spellcheck="true"> // 监听上传进度
</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>evt<span class="token punctuation">.</span>lengthComputable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment" spellcheck="true"> // 添加您的代码
</span>        <span class="token keyword">var</span> percentage <span class="token operator">=</span> <span class="token punctuation">(</span>evt<span class="token punctuation">.</span>loaded <span class="token operator">/</span> evt<span class="token punctuation">.</span>total<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log<span class="token punctuation">(</span></span><span class="token string">&#x27;上传中，已上传了&#x27;</span> <span class="token operator">+</span> percentage <span class="token operator">+</span> <span class="token string">&#x27;%&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></div><div class="docs-prevnext"><a class="docs-next" href="advanced-topics-security-issue.html#content">下一篇 →</a></div></div></section><footer class="wrap"><div class="right">© 2016 Baidu Inc.</div></footer></div></body></html>